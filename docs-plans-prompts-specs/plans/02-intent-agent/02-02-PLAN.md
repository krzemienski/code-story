---
phase: 02-intent-agent
type: execute
domain: claude-agent-sdk
---

# Phase 2 Plan 02: Intent Analysis Tools Enhancement

## Objective

Enhance the Intent Agent with advanced conversation state tracking and summarization tools.

**Purpose**: Enable natural conversation flow with intelligent follow-up questions.
**Output**: Additional tools for conversation management and intent summarization.

## Context

- @BRIEF.md
- @plans/02-intent-agent/02-01-SUMMARY.md

## Tasks

### Task 1: Add Conversation State Tool

**File**: `src/codestory/agents/intent/tools.py` (append)

```python
@tool(
    name="track_conversation_state",
    description="Track and update conversation state from user message",
    input_schema={
        "type": "object",
        "properties": {
            "message": {
                "type": "string",
                "description": "User's message to analyze"
            },
            "current_state": {
                "type": "object",
                "description": "Current conversation state",
                "properties": {
                    "turn_count": {"type": "integer"},
                    "has_stated_goal": {"type": "boolean"},
                    "has_background": {"type": "boolean"},
                    "has_focus_areas": {"type": "boolean"},
                    "has_time_preference": {"type": "boolean"},
                    "stated_goal": {"type": "string"},
                    "expertise_level": {"type": "string"}
                }
            }
        },
        "required": ["message"]
    }
)
async def track_conversation_state(args: dict) -> dict:
    """Update conversation state based on user message content."""
    message = args["message"]
    state = args.get("current_state", {})
    message_lower = message.lower()
    
    # Initialize state if needed
    turn_count = state.get("turn_count", 0) + 1
    has_goal = state.get("has_stated_goal", False)
    has_bg = state.get("has_background", False)
    has_focus = state.get("has_focus_areas", False)
    has_time = state.get("has_time_preference", False)
    stated_goal = state.get("stated_goal", "")
    expertise = state.get("expertise_level", "intermediate")
    
    # Detect goal statements
    goal_indicators = ["want to", "trying to", "need to", "looking to", "learn about", "understand"]
    if any(ind in message_lower for ind in goal_indicators):
        has_goal = True
        stated_goal = message
    
    # Detect background information
    bg_indicators = ["experience", "worked with", "familiar", "new to", "years", "beginner", "expert"]
    if any(ind in message_lower for ind in bg_indicators):
        has_bg = True
        # Update expertise assessment
        if any(kw in message_lower for kw in ["senior", "expert", "years"]):
            expertise = "expert"
        elif any(kw in message_lower for kw in ["new", "learning", "beginner"]):
            expertise = "beginner"
    
    # Detect focus areas
    focus_indicators = ["interested in", "focus on", "specifically", "particular", "this part"]
    if any(ind in message_lower for ind in focus_indicators):
        has_focus = True
    
    # Detect time preferences
    time_indicators = ["minutes", "quick", "brief", "detailed", "comprehensive", "short", "long"]
    if any(ind in message_lower for ind in time_indicators):
        has_time = True
    
    updated_state = {
        "turn_count": turn_count,
        "has_stated_goal": has_goal,
        "has_background": has_bg,
        "has_focus_areas": has_focus,
        "has_time_preference": has_time,
        "stated_goal": stated_goal,
        "expertise_level": expertise,
        "completeness": sum([has_goal, has_bg, has_focus, has_time]) / 4.0,
        "ready_for_plan": has_goal and has_bg,
    }
    
    return {"content": [{"type": "text", "text": str(updated_state)}]}


@tool(
    name="summarize_intent",
    description="Create a summary of understood intent for user confirmation",
    input_schema={
        "type": "object",
        "properties": {
            "stated_goal": {"type": "string", "description": "User's learning objective"},
            "expertise_level": {"type": "string", "description": "Assessed expertise level"},
            "focus_areas": {
                "type": "array",
                "items": {"type": "string"},
                "description": "Identified areas of interest"
            },
            "preferred_style": {"type": "string", "description": "Selected narrative style"},
            "time_preference": {"type": "integer", "description": "Preferred duration in minutes"}
        },
        "required": ["stated_goal", "expertise_level", "preferred_style"]
    }
)
async def summarize_intent(args: dict) -> dict:
    """Create a summary for user confirmation."""
    goal = args["stated_goal"]
    expertise = args["expertise_level"]
    focus = args.get("focus_areas", [])
    style = args["preferred_style"]
    duration = args.get("time_preference", 15)
    
    focus_str = ", ".join(focus) if focus else "the overall codebase"
    
    style_desc = {
        "fiction": "an engaging story with characters and narrative",
        "documentary": "an informative documentary-style exploration",
        "tutorial": "a step-by-step learning guide",
        "podcast": "a conversational discussion",
        "technical": "a precise technical deep-dive",
    }.get(style, "an informative exploration")
    
    expertise_desc = {
        "beginner": "newcomer-friendly explanations",
        "intermediate": "balanced technical depth",
        "expert": "advanced technical details",
    }.get(expertise, "appropriate explanations")
    
    summary = f"""Here's what I understand:

**Goal**: {goal}

**Focus**: {focus_str}

**Style**: I'll create {style_desc} with {expertise_desc}.

**Length**: Approximately {duration} minutes.

Does this sound right?"""
    
    result = {
        "summary": summary,
        "structured_intent": {
            "goal": goal,
            "expertise": expertise,
            "focus_areas": focus,
            "style": style,
            "duration_minutes": duration,
        },
        "ready_for_confirmation": True,
    }
    
    return {"content": [{"type": "text", "text": str(result)}]}
```

### Task 2: Update MCP Server with New Tools

**File**: `src/codestory/agents/intent/agent.py` (update)

```python
"""Intent Agent using Claude Agent SDK patterns - Updated."""

from claude_agent_sdk import (
    tool,
    create_sdk_mcp_server,
    ClaudeAgentOptions,
    ClaudeSDKClient,
    AgentDefinition,
)

from .tools import (
    analyze_user_intent,
    generate_story_plan,
    suggest_follow_up_questions,
    track_conversation_state,
    summarize_intent,
)


INTENT_AGENT_PROMPT = """You are the Intent Agent for Code Story, an AI that helps users understand codebases through audio narratives.

Your role is to conduct a friendly, conversational onboarding to understand:
1. What the user wants to learn about the repository
2. Their technical background and expertise level
3. Specific components or features they're interested in
4. How they prefer to learn (high-level overview vs. deep dive)

## Tools Available

- track_conversation_state: Update state from each user message
- analyze_user_intent: Categorize user's learning goals and expertise
- suggest_follow_up_questions: Get appropriate questions based on progress
- summarize_intent: Create summary for user confirmation
- generate_story_plan: Create structured plan with chapters and timing

## Conversation Flow

1. Greet user warmly and ask about their primary goal
2. After each response, use track_conversation_state to update progress
3. Use suggest_follow_up_questions to determine what to ask next
4. When completeness > 0.75, use summarize_intent to confirm
5. After confirmation, use generate_story_plan to create the final plan

Keep the conversation natural - one or two questions at a time."""


# Create MCP server with all intent tools
intent_mcp_server = create_sdk_mcp_server(
    name="intent",
    version="1.0.0",
    tools=[
        analyze_user_intent,
        generate_story_plan,
        suggest_follow_up_questions,
        track_conversation_state,
        summarize_intent,
    ]
)


def create_intent_agent_options() -> ClaudeAgentOptions:
    """Create ClaudeAgentOptions with Intent Agent configuration."""
    return ClaudeAgentOptions(
        mcp_servers={"intent": intent_mcp_server},
        agents={
            "intent-agent": AgentDefinition(
                description="Understands user intent through conversational onboarding",
                prompt=INTENT_AGENT_PROMPT,
                tools=[
                    "mcp__intent__analyze_user_intent",
                    "mcp__intent__generate_story_plan",
                    "mcp__intent__suggest_follow_up_questions",
                    "mcp__intent__track_conversation_state",
                    "mcp__intent__summarize_intent",
                ],
                model="sonnet",  # Balanced for conversation
            )
        }
    )


class IntentAgent:
    """High-level wrapper for Intent Agent operations."""
    
    def __init__(self):
        self.options = create_intent_agent_options()
        self.client = ClaudeSDKClient(self.options)
        self.conversation_history = []
        self.conversation_state = {
            "turn_count": 0,
            "has_stated_goal": False,
            "has_background": False,
            "has_focus_areas": False,
            "has_time_preference": False,
            "stated_goal": "",
            "expertise_level": "intermediate",
            "completeness": 0.0,
            "ready_for_plan": False,
        }
        self.story_plan = None
    
    async def start_conversation(self, repo_url: str) -> str:
        """Start a new onboarding conversation."""
        self.conversation_history = []
        self.repo_url = repo_url
        
        message = f"I'd like to create an audio story about this repository: {repo_url}\n\nPlease help me understand your goals."
        
        response = await self.client.run_agent(
            agent_name="intent-agent",
            message=message,
        )
        
        self.conversation_history.append({"role": "user", "content": message})
        self.conversation_history.append({"role": "assistant", "content": response})
        
        return response
    
    async def continue_conversation(self, user_message: str) -> str:
        """Continue the onboarding conversation."""
        self.conversation_history.append({"role": "user", "content": user_message})
        
        response = await self.client.run_agent(
            agent_name="intent-agent",
            message=user_message,
            conversation_history=self.conversation_history[:-1],
        )
        
        self.conversation_history.append({"role": "assistant", "content": response})
        
        return response
    
    def get_conversation_state(self) -> dict:
        """Get current conversation state."""
        return self.conversation_state.copy()
    
    def is_complete(self) -> bool:
        """Check if onboarding is complete."""
        return self.conversation_state.get("ready_for_plan", False)
```

### Task 3: Update Package Exports

**File**: `src/codestory/agents/intent/__init__.py` (update)

```python
"""Intent Agent package using Claude Agent SDK."""

from .tools import (
    analyze_user_intent,
    generate_story_plan,
    suggest_follow_up_questions,
    track_conversation_state,
    summarize_intent,
    INTENT_CATEGORIES,
    EXPERTISE_LEVELS,
    NARRATIVE_STYLES,
)
from .agent import (
    IntentAgent,
    intent_mcp_server,
    create_intent_agent_options,
    INTENT_AGENT_PROMPT,
)

__all__ = [
    # Tools
    "analyze_user_intent",
    "generate_story_plan",
    "suggest_follow_up_questions",
    "track_conversation_state",
    "summarize_intent",
    # Constants
    "INTENT_CATEGORIES",
    "EXPERTISE_LEVELS",
    "NARRATIVE_STYLES",
    # Agent
    "IntentAgent",
    "intent_mcp_server",
    "create_intent_agent_options",
    "INTENT_AGENT_PROMPT",
]
```

## Verification

```bash
uv run python -c "from codestory.agents.intent import track_conversation_state, summarize_intent; print('Tools OK')"
```

## Success Criteria

- track_conversation_state updates state from user messages
- summarize_intent creates user-friendly confirmation summaries
- MCP server includes all 5 tools
- AgentDefinition references all tool names correctly

## Next Step

Proceed to 02-03-PLAN.md for story plan data structures.
