# Plan 11-04: API Key Administration and Audit Logs

## Overview
Implement admin capabilities for API key oversight including viewing all keys across users, forced revocation, usage monitoring, and comprehensive audit logging using Claude Agent SDK patterns with security hooks for all sensitive operations.

## Dependencies
- Plan 11-01: Admin authentication with SDK patterns
- Plan 10-01: API key management
- Plan 11-03: Analytics infrastructure

## Claude Agent SDK Architecture

### 1. API Key Admin Tools with @tool Decorator

**src/codestory/tools/api_key_admin.py:**
```python
"""API Key administration tools using Claude Agent SDK @tool decorator."""
import uuid
from datetime import datetime, timedelta
from typing import Optional

from claude_agent_sdk import tool, create_sdk_mcp_server
from sqlalchemy import or_, func
from sqlalchemy.orm import Session

from src.codestory.models.api_key import APIKey
from src.codestory.models.user import User
from src.codestory.models.analytics import APICallLog


@tool(
    "list_all_api_keys",
    "List all API keys across all users with filtering and pagination.",
    {
        "search": str,  # optional search term
        "user_id": str,  # optional filter by user
        "is_active": bool,  # optional filter by active status
        "page": int,
        "per_page": int,
    }
)
async def list_all_api_keys(args: dict) -> dict:
    """List all API keys across all users."""
    from src.codestory.core.database import get_db_session

    async with get_db_session() as db:
        query = db.query(APIKey, User).join(User, APIKey.user_id == User.id)

        search = args.get("search")
        if search:
            search_term = f"%{search}%"
            query = query.filter(or_(
                APIKey.name.ilike(search_term),
                APIKey.key_prefix.ilike(search_term),
                User.email.ilike(search_term)
            ))

        user_id = args.get("user_id")
        if user_id:
            query = query.filter(APIKey.user_id == user_id)

        is_active = args.get("is_active")
        if is_active is not None:
            if is_active:
                query = query.filter(
                    APIKey.is_active == True,
                    APIKey.revoked_at.is_(None)
                )
            else:
                query = query.filter(or_(
                    APIKey.is_active == False,
                    APIKey.revoked_at.isnot(None)
                ))

        total = query.count()

        page = args.get("page", 1)
        per_page = args.get("per_page", 20)
        offset = (page - 1) * per_page
        results = query.order_by(APIKey.created_at.desc()).offset(offset).limit(per_page).all()

        keys = [
            {
                "id": key.id,
                "name": key.name,
                "key_prefix": key.key_prefix,
                "scopes": key.scopes.split(",") if key.scopes else [],
                "user_id": key.user_id,
                "user_email": user.email,
                "created_at": key.created_at.isoformat(),
                "expires_at": key.expires_at.isoformat() if key.expires_at else None,
                "last_used_at": key.last_used_at.isoformat() if key.last_used_at else None,
                "request_count": key.request_count,
                "is_active": key.is_active and key.revoked_at is None,
                "revoked_at": key.revoked_at.isoformat() if key.revoked_at else None,
            }
            for key, user in results
        ]

    return {"content": [{"type": "text", "text": str({"keys": keys, "total": total, "page": page, "per_page": per_page})}]}


@tool(
    "get_api_key_details",
    "Get detailed information about a specific API key including usage stats.",
    {
        "key_id": str,
    }
)
async def get_api_key_details(args: dict) -> dict:
    """Get detailed info about an API key."""
    from src.codestory.core.database import get_db_session

    key_id = args["key_id"]

    async with get_db_session() as db:
        result = db.query(APIKey, User).join(
            User, APIKey.user_id == User.id
        ).filter(APIKey.id == key_id).first()

        if not result:
            return {"content": [{"type": "text", "text": "API key not found"}]}

        key, user = result

        # Get usage stats
        week_ago = datetime.utcnow() - timedelta(days=7)
        recent_calls = db.query(APICallLog).filter(
            APICallLog.user_id == key.user_id,
            APICallLog.created_at >= week_ago
        ).count()

        details = {
            "key": {
                "id": key.id,
                "name": key.name,
                "description": key.description,
                "key_prefix": key.key_prefix,
                "scopes": key.scopes.split(",") if key.scopes else [],
                "created_at": key.created_at.isoformat(),
                "expires_at": key.expires_at.isoformat() if key.expires_at else None,
                "last_used_at": key.last_used_at.isoformat() if key.last_used_at else None,
                "request_count": key.request_count,
                "is_active": key.is_active,
                "revoked_at": key.revoked_at.isoformat() if key.revoked_at else None,
            },
            "user": {
                "id": user.id,
                "email": user.email,
                "name": user.name,
                "plan": user.plan,
            },
            "stats": {
                "requests_last_7_days": recent_calls,
            }
        }

    return {"content": [{"type": "text", "text": str(details)}]}


@tool(
    "admin_revoke_api_key",
    "Force revoke an API key. This is a sensitive operation requiring admin privileges.",
    {
        "key_id": str,
        "reason": str,
    }
)
async def admin_revoke_api_key(args: dict) -> dict:
    """Admin force-revoke an API key."""
    from src.codestory.core.database import get_db_session

    key_id = args["key_id"]
    reason = args["reason"]

    async with get_db_session() as db:
        key = db.query(APIKey).filter(APIKey.id == key_id).first()

        if not key:
            return {"content": [{"type": "text", "text": "API key not found"}]}

        key.revoked_at = datetime.utcnow()
        key.is_active = False

        db.commit()

    return {"content": [{"type": "text", "text": f"API key {key_id} revoked successfully. Reason: {reason}"}]}


@tool(
    "get_api_key_stats",
    "Get platform-wide API key statistics.",
    {}
)
async def get_api_key_stats(args: dict) -> dict:
    """Get platform-wide API key statistics."""
    from src.codestory.core.database import get_db_session

    async with get_db_session() as db:
        total_keys = db.query(func.count(APIKey.id)).scalar()
        active_keys = db.query(func.count(APIKey.id)).filter(
            APIKey.is_active == True,
            APIKey.revoked_at.is_(None)
        ).scalar()

        # Keys by scope
        all_keys = db.query(APIKey.scopes).all()
        scope_counts = {}
        for (scopes,) in all_keys:
            if scopes:
                for scope in scopes.split(","):
                    scope_counts[scope] = scope_counts.get(scope, 0) + 1

        # Recently active (used in last 7 days)
        week_ago = datetime.utcnow() - timedelta(days=7)
        recently_active = db.query(func.count(APIKey.id)).filter(
            APIKey.last_used_at >= week_ago
        ).scalar()

        stats = {
            "total_keys": total_keys,
            "active_keys": active_keys,
            "revoked_keys": total_keys - active_keys,
            "recently_active": recently_active,
            "by_scope": scope_counts,
        }

    return {"content": [{"type": "text", "text": str(stats)}]}


def create_api_key_admin_server():
    """Create MCP server for API key admin tools."""
    return create_sdk_mcp_server(
        name="api_key_admin",
        version="1.0.0",
        tools=[
            list_all_api_keys,
            get_api_key_details,
            admin_revoke_api_key,
            get_api_key_stats,
        ]
    )
```

### 2. Audit Log Tools

**src/codestory/tools/audit.py:**
```python
"""Audit logging tools using Claude Agent SDK @tool decorator."""
import uuid
from datetime import datetime, timedelta
from typing import Optional

from claude_agent_sdk import tool, create_sdk_mcp_server
from sqlalchemy import or_
from sqlalchemy.orm import Session

from src.codestory.models.audit_log import AuditLog


@tool(
    "query_audit_logs",
    "Query audit logs with filtering and pagination.",
    {
        "category": str,  # optional: auth, user, api_key, story, system
        "action": str,  # optional
        "actor_id": str,  # optional
        "target_type": str,  # optional
        "target_id": str,  # optional
        "start_date": str,  # optional ISO date
        "end_date": str,  # optional ISO date
        "status": str,  # optional: success, failure, warning
        "search": str,  # optional
        "page": int,
        "per_page": int,
    }
)
async def query_audit_logs(args: dict) -> dict:
    """Query audit logs with filters."""
    from src.codestory.core.database import get_db_session

    async with get_db_session() as db:
        query = db.query(AuditLog)

        if args.get("category"):
            query = query.filter(AuditLog.category == args["category"])
        if args.get("action"):
            query = query.filter(AuditLog.action == args["action"])
        if args.get("actor_id"):
            query = query.filter(AuditLog.actor_id == args["actor_id"])
        if args.get("target_type"):
            query = query.filter(AuditLog.target_type == args["target_type"])
        if args.get("target_id"):
            query = query.filter(AuditLog.target_id == args["target_id"])
        if args.get("start_date"):
            start = datetime.fromisoformat(args["start_date"])
            query = query.filter(AuditLog.created_at >= start)
        if args.get("end_date"):
            end = datetime.fromisoformat(args["end_date"])
            query = query.filter(AuditLog.created_at <= end)
        if args.get("status"):
            query = query.filter(AuditLog.status == args["status"])
        if args.get("search"):
            search_term = f"%{args['search']}%"
            query = query.filter(or_(
                AuditLog.actor_email.ilike(search_term),
                AuditLog.target_description.ilike(search_term),
                AuditLog.action.ilike(search_term)
            ))

        total = query.count()

        page = args.get("page", 1)
        per_page = args.get("per_page", 50)
        offset = (page - 1) * per_page
        logs = query.order_by(AuditLog.created_at.desc()).offset(offset).limit(per_page).all()

        result = {
            "logs": [
                {
                    "id": log.id,
                    "action": log.action,
                    "category": log.category,
                    "actor_type": log.actor_type,
                    "actor_id": log.actor_id,
                    "actor_email": log.actor_email,
                    "target_type": log.target_type,
                    "target_id": log.target_id,
                    "target_description": log.target_description,
                    "details": log.details,
                    "status": log.status,
                    "ip_address": log.ip_address,
                    "created_at": log.created_at.isoformat(),
                }
                for log in logs
            ],
            "total": total,
            "page": page,
            "per_page": per_page,
        }

    return {"content": [{"type": "text", "text": str(result)}]}


@tool(
    "get_audit_summary",
    "Get summary of audit activity for a time period.",
    {
        "days": int,  # number of days to summarize
    }
)
async def get_audit_summary(args: dict) -> dict:
    """Get audit activity summary."""
    from src.codestory.core.database import get_db_session

    days = args.get("days", 7)
    end_date = datetime.utcnow()
    start_date = end_date - timedelta(days=days)

    async with get_db_session() as db:
        logs = db.query(AuditLog).filter(
            AuditLog.created_at >= start_date,
            AuditLog.created_at <= end_date
        ).all()

        by_category = {}
        by_action = {}
        by_status = {"success": 0, "failure": 0, "warning": 0}

        for log in logs:
            by_category[log.category] = by_category.get(log.category, 0) + 1
            by_action[log.action] = by_action.get(log.action, 0) + 1
            if log.status in by_status:
                by_status[log.status] += 1

        summary = {
            "total_events": len(logs),
            "by_category": by_category,
            "by_action": by_action,
            "by_status": by_status,
            "period_days": days,
        }

    return {"content": [{"type": "text", "text": str(summary)}]}


@tool(
    "get_audit_categories",
    "Get available audit categories and actions for filtering.",
    {}
)
async def get_audit_categories(args: dict) -> dict:
    """Get available audit categories and actions."""
    categories = {
        "categories": ["auth", "user", "api_key", "story", "system", "analytics"],
        "actions": {
            "auth": ["admin_login", "admin_logout", "admin_2fa_enabled", "admin_login_failed"],
            "user": ["user_created", "user_updated", "user_suspended", "user_unsuspended", "user_impersonated", "user_quota_updated"],
            "api_key": ["api_key_created", "api_key_revoked", "api_key_admin_revoked"],
            "story": ["story_created", "story_deleted", "story_updated"],
            "system": ["system_setting_changed", "export_initiated"],
            "analytics": ["analytics_dashboard_viewed", "analytics_data_exported"],
        }
    }
    return {"content": [{"type": "text", "text": str(categories)}]}


@tool(
    "create_audit_log",
    "Create an audit log entry for an action.",
    {
        "action": str,
        "category": str,
        "actor_type": str,
        "actor_id": str,
        "actor_email": str,
        "target_type": str,
        "target_id": str,
        "target_description": str,
        "details": dict,
        "status": str,
        "ip_address": str,
    }
)
async def create_audit_log(args: dict) -> dict:
    """Create an audit log entry."""
    from src.codestory.core.database import get_db_session

    async with get_db_session() as db:
        log = AuditLog(
            id=str(uuid.uuid4()),
            action=args["action"],
            category=args["category"],
            actor_type=args.get("actor_type", "system"),
            actor_id=args.get("actor_id"),
            actor_email=args.get("actor_email"),
            target_type=args.get("target_type"),
            target_id=args.get("target_id"),
            target_description=args.get("target_description"),
            details=args.get("details"),
            status=args.get("status", "success"),
            ip_address=args.get("ip_address"),
            created_at=datetime.utcnow(),
        )
        db.add(log)
        db.commit()

    return {"content": [{"type": "text", "text": f"Audit log created: {log.id}"}]}


def create_audit_server():
    """Create MCP server for audit tools."""
    return create_sdk_mcp_server(
        name="audit",
        version="1.0.0",
        tools=[
            query_audit_logs,
            get_audit_summary,
            get_audit_categories,
            create_audit_log,
        ]
    )
```

### 3. Security Hooks for API Key Admin

**src/codestory/hooks/api_key_admin_hooks.py:**
```python
"""Security hooks for API key administration."""
import uuid
from datetime import datetime
from typing import Any

import redis.asyncio as redis

from src.codestory.core.config import settings


async def validate_api_key_admin_request(
    input_data: dict,
    tool_use_id: str,
    context: dict
) -> dict:
    """PreToolUse hook: Validate API key admin access and rate limit."""
    tool_name = input_data.get("tool_name", "")

    if not tool_name.startswith("mcp__api_key_admin__"):
        return {}

    admin_id = context.get("admin_id")
    if not admin_id:
        return {
            "hookSpecificOutput": {
                "hookEventName": "PreToolUse",
                "permissionDecision": "deny",
                "permissionDecisionReason": "API key admin access requires admin authentication"
            }
        }

    # Rate limiting: Different limits for different operations
    redis_client = redis.from_url(settings.redis_url)
    tool_short = tool_name.replace("mcp__api_key_admin__", "")

    # Stricter limits for revocation
    if tool_short == "admin_revoke_api_key":
        rate_key = f"apikey_revoke_rate:{admin_id}"
        limit = 5  # 5 revocations per minute max
    else:
        rate_key = f"apikey_admin_rate:{admin_id}"
        limit = 20  # 20 requests per minute for read operations

    try:
        current = await redis_client.incr(rate_key)
        if current == 1:
            await redis_client.expire(rate_key, 60)

        if current > limit:
            return {
                "hookSpecificOutput": {
                    "hookEventName": "PreToolUse",
                    "permissionDecision": "deny",
                    "permissionDecisionReason": f"Rate limit exceeded: {limit} {tool_short} operations per minute"
                }
            }
    finally:
        await redis_client.close()

    return {}


async def audit_api_key_admin_action(
    input_data: dict,
    tool_use_id: str,
    context: dict
) -> dict:
    """PostToolUse hook: Audit all API key admin actions."""
    tool_name = input_data.get("tool_name", "")

    if not tool_name.startswith("mcp__api_key_admin__"):
        return {}

    from src.codestory.core.database import get_db_session
    from src.codestory.models.audit_log import AuditLog

    admin_id = context.get("admin_id")
    admin_email = context.get("admin_email")
    tool_input = input_data.get("tool_input", {})
    tool_short = tool_name.replace("mcp__api_key_admin__", "")

    # Map tools to audit actions
    action_map = {
        "list_all_api_keys": "api_keys_listed",
        "get_api_key_details": "api_key_details_viewed",
        "admin_revoke_api_key": "api_key_admin_revoked",
        "get_api_key_stats": "api_key_stats_viewed",
    }

    action = action_map.get(tool_short, f"api_key_{tool_short}")

    details = {
        "tool": tool_short,
        "timestamp": datetime.utcnow().isoformat(),
        "ip_address": context.get("ip_address"),
    }

    # Extra logging for sensitive operations
    if tool_short == "admin_revoke_api_key":
        details["key_id"] = tool_input.get("key_id")
        details["reason"] = tool_input.get("reason")
        details["alert"] = "SENSITIVE_OPERATION"

    if tool_short == "get_api_key_details":
        details["key_id"] = tool_input.get("key_id")

    async with get_db_session() as db:
        audit_entry = AuditLog(
            id=str(uuid.uuid4()),
            admin_id=admin_id,
            action=action,
            target_type="api_key",
            target_id=tool_input.get("key_id"),
            details=details,
            actor_type="admin",
            actor_email=admin_email,
            category="api_key",
            status="success",
            ip_address=context.get("ip_address"),
            created_at=datetime.utcnow()
        )
        db.add(audit_entry)
        db.commit()

    return {}


async def notify_key_revocation(
    input_data: dict,
    tool_use_id: str,
    context: dict
) -> dict:
    """PostToolUse hook: Send notification on API key revocation."""
    tool_name = input_data.get("tool_name", "")

    if tool_name != "mcp__api_key_admin__admin_revoke_api_key":
        return {}

    tool_input = input_data.get("tool_input", {})
    key_id = tool_input.get("key_id")
    reason = tool_input.get("reason")
    admin_email = context.get("admin_email")

    # Send notification (async task)
    from src.codestory.tasks.notifications import send_key_revocation_notification

    await send_key_revocation_notification.delay(
        key_id=key_id,
        reason=reason,
        revoked_by=admin_email
    )

    return {}


async def cleanup_api_key_admin_session(
    input_data: dict,
    tool_use_id: str,
    context: dict
) -> dict:
    """Stop hook: Clean up API key admin session."""
    session_id = context.get("session_id")

    if session_id:
        redis_client = redis.from_url(settings.redis_url)
        try:
            await redis_client.delete(f"apikey_admin_session:{session_id}")
        finally:
            await redis_client.close()

    return {}
```

### 4. SDK Configuration for API Key Admin

**src/codestory/agents/api_key_admin_config.py:**
```python
"""Claude Agent SDK configuration for API key administration."""
import uuid
from fastapi import Request
from sqlalchemy.orm import Session

from claude_agent_sdk import ClaudeAgentOptions, HookMatcher, SandboxSettings

from src.codestory.tools.api_key_admin import create_api_key_admin_server
from src.codestory.tools.audit import create_audit_server
from src.codestory.hooks.api_key_admin_hooks import (
    validate_api_key_admin_request,
    audit_api_key_admin_action,
    notify_key_revocation,
    cleanup_api_key_admin_session,
)
from src.codestory.models.admin import AdminUser


def get_api_key_admin_sdk_options(
    request: Request,
    db: Session,
    admin: AdminUser
) -> ClaudeAgentOptions:
    """Get SDK options for API key admin operations with security hooks."""

    api_key_server = create_api_key_admin_server()
    audit_server = create_audit_server()
    session_id = str(uuid.uuid4())

    # Context for hooks
    hook_context = {
        "admin_id": admin.id,
        "admin_email": admin.email,
        "ip_address": request.client.host if request.client else None,
        "session_id": session_id,
        "db": db,
    }

    return ClaudeAgentOptions(
        mcp_servers={
            "api_key_admin": api_key_server,
            "audit": audit_server,
        },
        allowed_tools=[
            "mcp__api_key_admin__list_all_api_keys",
            "mcp__api_key_admin__get_api_key_details",
            "mcp__api_key_admin__admin_revoke_api_key",
            "mcp__api_key_admin__get_api_key_stats",
            "mcp__audit__query_audit_logs",
            "mcp__audit__get_audit_summary",
            "mcp__audit__get_audit_categories",
            # create_audit_log is internal-only
        ],
        permission_mode="default",  # CRITICAL: Never bypassPermissions in production
        sandbox=SandboxSettings(
            enabled=True,
            network="host",  # Allow database access
        ),
        hooks={
            "PreToolUse": [
                HookMatcher(
                    matcher="mcp__api_key_admin__*",
                    hooks=[validate_api_key_admin_request],
                    context=hook_context
                )
            ],
            "PostToolUse": [
                HookMatcher(
                    matcher="mcp__api_key_admin__*",
                    hooks=[audit_api_key_admin_action, notify_key_revocation],
                    context=hook_context
                )
            ],
            "Stop": [
                HookMatcher(
                    matcher="*",
                    hooks=[cleanup_api_key_admin_session],
                    context=hook_context
                )
            ],
        },
        max_turns=15,
    )
```

### 5. API Key Admin Router with SDK Integration

**src/codestory/backend/api/routers/admin_api_keys.py:**
```python
"""Admin API key management endpoints using Claude Agent SDK."""
from fastapi import APIRouter, Depends, HTTPException, status, Query, Request
from sqlalchemy.orm import Session
from typing import Optional

from claude_agent_sdk import ClaudeSDKClient

from src.codestory.core.database import get_db
from src.codestory.models.admin import AdminUser, Permission
from src.codestory.backend.api.deps import require_permission
from src.codestory.agents.api_key_admin_config import get_api_key_admin_sdk_options

router = APIRouter(prefix="/admin/api-keys", tags=["admin-api-keys"])


@router.get("")
async def list_api_keys(
    request: Request,
    search: Optional[str] = None,
    user_id: Optional[str] = None,
    is_active: Optional[bool] = None,
    page: int = Query(1, ge=1),
    per_page: int = Query(20, ge=1, le=100),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_API_KEYS)),
    db: Session = Depends(get_db)
):
    """List all API keys across users via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        query_parts = [f"List API keys page {page} with {per_page} per page"]
        if search:
            query_parts.append(f"search for '{search}'")
        if user_id:
            query_parts.append(f"filter by user {user_id}")
        if is_active is not None:
            query_parts.append(f"filter by active={is_active}")

        await client.query(" ".join(query_parts))

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = eval(block.text)

        return result


@router.get("/stats")
async def get_api_key_stats(
    request: Request,
    admin: AdminUser = Depends(require_permission(Permission.VIEW_API_KEYS)),
    db: Session = Depends(get_db)
):
    """Get API key statistics via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        await client.query("Get platform-wide API key statistics")

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = eval(block.text)

        return result


@router.get("/{key_id}")
async def get_api_key(
    request: Request,
    key_id: str,
    admin: AdminUser = Depends(require_permission(Permission.VIEW_API_KEYS)),
    db: Session = Depends(get_db)
):
    """Get detailed API key info via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        await client.query(f"Get details for API key {key_id}")

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = eval(block.text)

        if not result or result == "API key not found":
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="API key not found"
            )

        return result


@router.post("/{key_id}/revoke")
async def revoke_api_key(
    request: Request,
    key_id: str,
    reason: str = Query(..., min_length=1),
    admin: AdminUser = Depends(require_permission(Permission.REVOKE_API_KEYS)),
    db: Session = Depends(get_db)
):
    """Admin force-revoke an API key via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        await client.query(f"Revoke API key {key_id} with reason: {reason}")

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = block.text

        if "not found" in result.lower():
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="API key not found"
            )

        return {"message": "API key revoked", "key_id": key_id}
```

### 6. Audit Log Router with SDK Integration

**src/codestory/backend/api/routers/admin_audit.py:**
```python
"""Admin audit log endpoints using Claude Agent SDK."""
from datetime import datetime
from fastapi import APIRouter, Depends, Query, Request
from sqlalchemy.orm import Session
from typing import Optional

from claude_agent_sdk import ClaudeSDKClient

from src.codestory.core.database import get_db
from src.codestory.models.admin import AdminUser, Permission
from src.codestory.backend.api.deps import require_permission
from src.codestory.agents.api_key_admin_config import get_api_key_admin_sdk_options

router = APIRouter(prefix="/admin/audit", tags=["admin-audit"])


@router.get("/logs")
async def get_audit_logs(
    request: Request,
    category: Optional[str] = None,
    action: Optional[str] = None,
    actor_id: Optional[str] = None,
    target_type: Optional[str] = None,
    target_id: Optional[str] = None,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None,
    status: Optional[str] = None,
    search: Optional[str] = None,
    page: int = Query(1, ge=1),
    per_page: int = Query(50, ge=1, le=100),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_AUDIT_LOGS)),
    db: Session = Depends(get_db)
):
    """Query audit logs via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        query_parts = [f"Query audit logs page {page}"]
        if category:
            query_parts.append(f"category={category}")
        if action:
            query_parts.append(f"action={action}")
        if status:
            query_parts.append(f"status={status}")
        if search:
            query_parts.append(f"search='{search}'")

        await client.query(" ".join(query_parts))

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = eval(block.text)

        return result


@router.get("/summary")
async def get_audit_summary(
    request: Request,
    days: int = Query(7, ge=1, le=90),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_AUDIT_LOGS)),
    db: Session = Depends(get_db)
):
    """Get audit activity summary via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        await client.query(f"Get audit summary for last {days} days")

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = eval(block.text)

        return result


@router.get("/categories")
async def get_audit_categories(
    request: Request,
    admin: AdminUser = Depends(require_permission(Permission.VIEW_AUDIT_LOGS)),
    db: Session = Depends(get_db)
):
    """Get available audit categories and actions via Claude Agent SDK."""
    options = get_api_key_admin_sdk_options(request, db, admin)

    async with ClaudeSDKClient(options=options) as client:
        await client.query("Get audit categories and actions")

        result = None
        async for message in client.receive_response():
            if hasattr(message, 'content'):
                for block in message.content:
                    if hasattr(block, 'text'):
                        result = eval(block.text)

        return result
```

### 7. Audit Log Model

**src/codestory/models/audit_log.py:**
```python
"""Audit logging models."""
from datetime import datetime
from sqlalchemy import Column, String, DateTime, JSON, Text, Index
from src.codestory.core.database import Base


class AuditLog(Base):
    """Comprehensive audit log for admin and system actions."""
    __tablename__ = "audit_logs"

    id = Column(String(36), primary_key=True)

    # Actor - who performed the action
    actor_type = Column(String(20), nullable=False)  # admin, system, user
    actor_id = Column(String(36), nullable=True)
    actor_email = Column(String(255), nullable=True)

    # Action details
    action = Column(String(100), nullable=False, index=True)
    category = Column(String(50), nullable=False, index=True)

    # Target - what was affected
    target_type = Column(String(50), nullable=True)
    target_id = Column(String(36), nullable=True)
    target_description = Column(String(255), nullable=True)

    # Context
    details = Column(JSON, nullable=True)
    changes = Column(JSON, nullable=True)

    # Request metadata
    ip_address = Column(String(45), nullable=True)
    user_agent = Column(String(500), nullable=True)
    request_id = Column(String(36), nullable=True)

    # Status
    status = Column(String(20), default="success")
    error_message = Column(Text, nullable=True)

    # Admin reference (for admin actions)
    admin_id = Column(String(36), nullable=True)

    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow, index=True)

    __table_args__ = (
        Index('ix_audit_actor', 'actor_type', 'actor_id'),
        Index('ix_audit_target', 'target_type', 'target_id'),
        Index('ix_audit_date_category', 'created_at', 'category'),
    )


class AuditActions:
    """Standard audit action names."""
    # Authentication
    ADMIN_LOGIN = "admin_login"
    ADMIN_LOGIN_FAILED = "admin_login_failed"
    ADMIN_LOGOUT = "admin_logout"
    ADMIN_2FA_ENABLED = "admin_2fa_enabled"

    # User management
    USER_CREATED = "user_created"
    USER_UPDATED = "user_updated"
    USER_DELETED = "user_deleted"
    USER_SUSPENDED = "user_suspended"
    USER_UNSUSPENDED = "user_unsuspended"
    USER_QUOTA_UPDATED = "user_quota_updated"
    USER_IMPERSONATED = "user_impersonated"

    # API keys
    API_KEY_CREATED = "api_key_created"
    API_KEY_REVOKED = "api_key_revoked"
    API_KEY_ADMIN_REVOKED = "api_key_admin_revoked"

    # System
    SYSTEM_SETTING_CHANGED = "system_setting_changed"
    EXPORT_INITIATED = "export_initiated"
```

### 8. Audit Logs UI Component (React)

**apps/admin-dashboard/src/pages/AuditLogsPage.tsx:**
```typescript
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Search, Eye, Shield, User, Key, FileAudio, Settings } from "lucide-react";
import { format } from "date-fns";
import { adminApi } from "@/lib/api";
import Pagination from "@/components/Pagination";

interface AuditLog {
  id: string;
  action: string;
  category: string;
  actor_type: string;
  actor_email: string;
  target_type: string;
  target_description: string;
  details: Record<string, any>;
  status: string;
  ip_address: string;
  created_at: string;
}

const categoryIcons: Record<string, any> = {
  auth: Shield,
  user: User,
  api_key: Key,
  story: FileAudio,
  system: Settings,
};

export default function AuditLogsPage() {
  const [search, setSearch] = useState("");
  const [category, setCategory] = useState<string>("all");
  const [status, setStatus] = useState<string>("all");
  const [page, setPage] = useState(1);
  const [selectedLog, setSelectedLog] = useState<AuditLog | null>(null);

  const { data, isLoading } = useQuery({
    queryKey: ["audit-logs", search, category, status, page],
    queryFn: () =>
      adminApi.get("/admin/audit/logs", {
        params: {
          search: search || undefined,
          category: category !== "all" ? category : undefined,
          status: status !== "all" ? status : undefined,
          page,
          per_page: 50,
        },
      }),
  });

  const { data: summary } = useQuery({
    queryKey: ["audit-summary"],
    queryFn: () => adminApi.get("/admin/audit/summary", { params: { days: 7 } }),
  });

  const logs = data?.logs || [];
  const totalPages = data?.pages || 1;

  const getStatusBadge = (status: string) => {
    const variants: Record<string, "default" | "destructive" | "secondary"> = {
      success: "default",
      failure: "destructive",
      warning: "secondary",
    };
    return <Badge variant={variants[status] || "secondary"}>{status}</Badge>;
  };

  const getCategoryIcon = (category: string) => {
    const Icon = categoryIcons[category] || Settings;
    return <Icon className="h-4 w-4" />;
  };

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Audit Logs</h1>
        <div className="text-sm text-muted-foreground">
          {summary?.total_events?.toLocaleString()} events in last 7 days
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-4 gap-4 mb-6">
        {summary?.by_category &&
          Object.entries(summary.by_category).map(([cat, count]) => (
            <div key={cat} className="border rounded-lg p-4">
              <div className="flex items-center gap-2 text-muted-foreground mb-1">
                {getCategoryIcon(cat)}
                <span className="capitalize">{cat}</span>
              </div>
              <div className="text-2xl font-bold">{(count as number).toLocaleString()}</div>
            </div>
          ))}
      </div>

      {/* Filters */}
      <div className="flex gap-4 mb-6">
        <div className="relative flex-1 max-w-md">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search logs..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10"
          />
        </div>

        <Select value={category} onValueChange={setCategory}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Category" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Categories</SelectItem>
            <SelectItem value="auth">Authentication</SelectItem>
            <SelectItem value="user">Users</SelectItem>
            <SelectItem value="api_key">API Keys</SelectItem>
            <SelectItem value="story">Stories</SelectItem>
            <SelectItem value="system">System</SelectItem>
          </SelectContent>
        </Select>

        <Select value={status} onValueChange={setStatus}>
          <SelectTrigger className="w-32">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="success">Success</SelectItem>
            <SelectItem value="failure">Failure</SelectItem>
            <SelectItem value="warning">Warning</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Logs Table */}
      <div className="border rounded-lg">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-12"></TableHead>
              <TableHead>Action</TableHead>
              <TableHead>Actor</TableHead>
              <TableHead>Target</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>IP Address</TableHead>
              <TableHead>Time</TableHead>
              <TableHead className="w-12"></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {isLoading ? (
              <TableRow>
                <TableCell colSpan={8} className="text-center py-8">
                  Loading...
                </TableCell>
              </TableRow>
            ) : logs.length === 0 ? (
              <TableRow>
                <TableCell colSpan={8} className="text-center py-8">
                  No logs found
                </TableCell>
              </TableRow>
            ) : (
              logs.map((log: AuditLog) => (
                <TableRow key={log.id}>
                  <TableCell>{getCategoryIcon(log.category)}</TableCell>
                  <TableCell>
                    <span className="font-medium">{log.action.replace(/_/g, " ")}</span>
                  </TableCell>
                  <TableCell>
                    <div className="text-sm">
                      {log.actor_email || log.actor_type}
                    </div>
                  </TableCell>
                  <TableCell>
                    <div className="text-sm text-muted-foreground">
                      {log.target_description || log.target_type || "—"}
                    </div>
                  </TableCell>
                  <TableCell>{getStatusBadge(log.status)}</TableCell>
                  <TableCell className="text-sm text-muted-foreground">
                    {log.ip_address || "—"}
                  </TableCell>
                  <TableCell className="text-sm text-muted-foreground">
                    {format(new Date(log.created_at), "MMM d, HH:mm")}
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => setSelectedLog(log)}
                    >
                      <Eye className="h-4 w-4" />
                    </Button>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <div className="mt-4">
        <Pagination
          currentPage={page}
          totalPages={totalPages}
          onPageChange={setPage}
        />
      </div>

      {/* Log Detail Dialog */}
      <Dialog open={!!selectedLog} onOpenChange={() => setSelectedLog(null)}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>Audit Log Details</DialogTitle>
          </DialogHeader>
          {selectedLog && (
            <div className="space-y-4">
              <div>
                <div className="text-sm text-muted-foreground">Action</div>
                <div className="font-medium">{selectedLog.action}</div>
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Actor</div>
                <div>{selectedLog.actor_email || selectedLog.actor_type}</div>
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Time</div>
                <div>{format(new Date(selectedLog.created_at), "PPpp")}</div>
              </div>
              <div>
                <div className="text-sm text-muted-foreground">IP Address</div>
                <div>{selectedLog.ip_address || "—"}</div>
              </div>
              {selectedLog.details && Object.keys(selectedLog.details).length > 0 && (
                <div>
                  <div className="text-sm text-muted-foreground mb-2">Details</div>
                  <pre className="bg-muted p-3 rounded text-xs overflow-auto">
                    {JSON.stringify(selectedLog.details, null, 2)}
                  </pre>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
```

## File Structure
```
src/codestory/
├── tools/
│   ├── api_key_admin.py    # @tool decorated API key admin tools
│   └── audit.py            # @tool decorated audit tools
├── hooks/
│   └── api_key_admin_hooks.py  # Security hooks
├── agents/
│   └── api_key_admin_config.py # SDK configuration
├── models/
│   └── audit_log.py        # Audit log model
└── backend/
    └── api/
        └── routers/
            ├── admin_api_keys.py  # API key endpoints
            └── admin_audit.py     # Audit log endpoints

apps/admin-dashboard/
└── src/
    └── pages/
        ├── APIKeysPage.tsx
        └── AuditLogsPage.tsx
```

## Validation Gates

### Gate 1: SDK Rate Limiting for Revocation
```python
def test_revocation_rate_limiting():
    """Verify SDK hook enforces stricter rate limits for revocation."""
    from src.codestory.hooks.api_key_admin_hooks import validate_api_key_admin_request

    # Simulate 6 revocation requests (over limit of 5)
    for i in range(6):
        result = await validate_api_key_admin_request(
            {"tool_name": "mcp__api_key_admin__admin_revoke_api_key", "tool_input": {}},
            f"tool_{i}",
            {"admin_id": "admin-123"}
        )

        if i < 5:
            assert result == {}  # Allowed
        else:
            assert result["hookSpecificOutput"]["permissionDecision"] == "deny"
            assert "Rate limit" in result["hookSpecificOutput"]["permissionDecisionReason"]
```

### Gate 2: Audit Logging on Revocation
```python
def test_revocation_audit_logging():
    """Verify API key revocation is audited with details."""
    from src.codestory.hooks.api_key_admin_hooks import audit_api_key_admin_action

    await audit_api_key_admin_action(
        {
            "tool_name": "mcp__api_key_admin__admin_revoke_api_key",
            "tool_input": {"key_id": "key-123", "reason": "Security concern"}
        },
        "tool_1",
        {"admin_id": "admin-123", "admin_email": "admin@example.com", "ip_address": "1.2.3.4"}
    )

    # Verify audit log entry
    from src.codestory.core.database import get_db_session
    from src.codestory.models.audit_log import AuditLog

    async with get_db_session() as db:
        log = db.query(AuditLog).filter(
            AuditLog.action == "api_key_admin_revoked"
        ).first()

        assert log is not None
        assert log.details["key_id"] == "key-123"
        assert log.details["reason"] == "Security concern"
        assert log.details["alert"] == "SENSITIVE_OPERATION"
```

### Gate 3: List All API Keys
```python
def test_list_all_api_keys():
    """Verify admin can list all API keys via SDK."""
    response = client.get("/admin/api-keys", headers=admin_headers)

    assert response.status_code == 200
    data = response.json()
    assert "keys" in data
    assert "total" in data
```

### Gate 4: Admin Revoke Key
```python
def test_admin_revoke_key():
    """Verify admin can revoke any API key via SDK."""
    key_id = create_test_api_key(user_id="other_user")

    response = client.post(
        f"/admin/api-keys/{key_id}/revoke",
        params={"reason": "Security concern"},
        headers=admin_headers
    )

    assert response.status_code == 200

    # Verify key is revoked
    key_resp = client.get(f"/admin/api-keys/{key_id}", headers=admin_headers)
    assert key_resp.json()["key"]["revoked_at"] is not None
```

### Gate 5: Audit Log Query
```python
def test_audit_log_query_via_sdk():
    """Verify audit logs can be queried via SDK."""
    response = client.get(
        "/admin/audit/logs",
        params={"category": "api_key", "page": 1},
        headers=admin_headers
    )

    assert response.status_code == 200
    data = response.json()
    assert "logs" in data

    # All logs should be in api_key category
    for log in data["logs"]:
        assert log["category"] == "api_key"
```

## Security Considerations

1. **Immutable Logs**: Audit logs cannot be modified or deleted (no update/delete tools exposed)
2. **Comprehensive Coverage**: All admin actions logged via PostToolUse hooks
3. **Request Metadata**: IP and session captured in hook context
4. **Rate Limiting**: Stricter limits for sensitive operations (5/min for revoke vs 20/min for read)
5. **Notification on Revocation**: Async notification sent to key owner
6. **Permission Mode**: Always "default" - never bypassPermissions in production

## Definition of Done
- [ ] API key admin tools with @tool decorator
- [ ] Audit log tools with @tool decorator
- [ ] Security hooks (rate limiting, audit logging, notification)
- [ ] SDK configuration with SandboxSettings
- [ ] Audit log model with indexes
- [ ] API key admin listing via SDK
- [ ] Admin key revocation with reason and audit
- [ ] Audit log query endpoint via SDK
- [ ] Audit activity summary
- [ ] API keys admin UI
- [ ] Audit logs UI with filtering
- [ ] Log detail view
- [ ] All validation gates passing
