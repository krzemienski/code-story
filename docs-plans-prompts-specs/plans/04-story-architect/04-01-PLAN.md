# Plan 04-01: Narrative Style Definitions

## Overview

**Phase**: 4 - Story Architect Agent
**Plan**: 01 of 05
**Depends on**: Phase 3 (Repo Analyzer Agent)
**Enables**: 04-02 (Chapter Scripts)

## Goal

Implement the 5 narrative style prompts for story generation: Fiction, Documentary, Tutorial, Podcast, and Technical. Create distinct voice and structure templates for each narrative style with voice synthesis directions.

## Claude Agent SDK Pattern

Uses `@tool` decorator for style selection and prompt generation:

```python
from claude_agent_sdk import tool, create_sdk_mcp_server

@tool(
    name="get_style_prompt",
    description="Get the system prompt for a narrative style",
    input_schema={...}
)
async def get_style_prompt(args: dict) -> dict:
    ...
    return {"content": [{"type": "text", "text": prompt}]}
```

## Tasks

### Task 1: Create Narrative Style Definitions

**File**: `src/codestory/tools/story/styles.py`

```python
"""Narrative style definitions for Code Story.

Uses Claude Agent SDK @tool decorator for MCP integration.
"""

import json
from dataclasses import dataclass, field, asdict
from enum import Enum
from typing import Any

from claude_agent_sdk import tool


class NarrativeStyle(str, Enum):
    """Available narrative styles for code stories."""
    FICTION = "fiction"
    DOCUMENTARY = "documentary"
    TUTORIAL = "tutorial"
    PODCAST = "podcast"
    TECHNICAL = "technical"


class ExpertiseLevel(str, Enum):
    """Target audience expertise level."""
    BEGINNER = "beginner"
    INTERMEDIATE = "intermediate"
    EXPERT = "expert"


@dataclass
class StyleDefinition:
    """Definition of a narrative style."""
    style: str
    name: str
    description: str
    voice_character: str
    pacing: str  # fast, moderate, slow
    tone: str
    chapter_pattern: list[str]
    example_phrases: list[str]
    voice_directions: dict[str, str]

    def to_dict(self) -> dict:
        return asdict(self)


STYLE_DEFINITIONS: dict[str, StyleDefinition] = {
    NarrativeStyle.FICTION.value: StyleDefinition(
        style=NarrativeStyle.FICTION.value,
        name="Fiction",
        description="Epic narrative that transforms code into an adventure story",
        voice_character="Dramatic narrator, like a fantasy audiobook",
        pacing="moderate",
        tone="Epic, dramatic, storytelling",
        chapter_pattern=[
            "The Beginning - Setting the Stage",
            "The Hero Emerges - Core Components",
            "The Journey - How Data Flows",
            "Challenges and Trials - Edge Cases",
            "The Climax - The Main Feature",
            "Resolution - How It All Comes Together",
        ],
        example_phrases=[
            "In the vast digital realm of {repo_name}, a story unfolds...",
            "Our hero, the {component}, stood ready to face any challenge...",
            "Through treacherous conditionals and perilous loops...",
            "And so, the data found its way home, transformed and triumphant.",
        ],
        voice_directions={
            "emphasis": "dramatic pauses before key reveals",
            "pace": "build tension, then release",
            "emotion": "wonder, excitement, resolution",
        },
    ),

    NarrativeStyle.DOCUMENTARY.value: StyleDefinition(
        style=NarrativeStyle.DOCUMENTARY.value,
        name="Documentary",
        description="Professional documentary-style narration like a tech documentary",
        voice_character="Authoritative narrator, like David Attenborough for code",
        pacing="moderate",
        tone="Informative, measured, insightful",
        chapter_pattern=[
            "Introduction - The Project at a Glance",
            "Origins - Why This Was Built",
            "Architecture - The Grand Design",
            "Key Components - Under the Hood",
            "In Action - How It Works",
            "Impact - What It Achieves",
        ],
        example_phrases=[
            "Here we observe {repo_name} in its natural habitat...",
            "The architecture reveals a fascinating pattern...",
            "Notice how the data flows through these carefully designed channels...",
            "This elegant solution addresses a fundamental challenge...",
        ],
        voice_directions={
            "emphasis": "highlight architectural decisions",
            "pace": "steady, contemplative",
            "emotion": "appreciation, insight, understanding",
        },
    ),

    NarrativeStyle.TUTORIAL.value: StyleDefinition(
        style=NarrativeStyle.TUTORIAL.value,
        name="Tutorial",
        description="Step-by-step educational walkthrough for learning",
        voice_character="Friendly instructor, like a patient coding mentor",
        pacing="slow",
        tone="Educational, encouraging, clear",
        chapter_pattern=[
            "Welcome - What You'll Learn",
            "Prerequisites - What You Need to Know",
            "Getting Started - The Basics",
            "Core Concepts - Understanding the Foundation",
            "Hands-On - Walking Through the Code",
            "Next Steps - Where to Go From Here",
        ],
        example_phrases=[
            "Let's take a look at how {repo_name} works...",
            "Don't worry if this seems complex at first...",
            "The key thing to understand here is...",
            "Great! Now you understand how this component functions.",
        ],
        voice_directions={
            "emphasis": "clear explanations, repeat key points",
            "pace": "deliberate, with pauses for absorption",
            "emotion": "encouraging, supportive, celebratory",
        },
    ),

    NarrativeStyle.PODCAST.value: StyleDefinition(
        style=NarrativeStyle.PODCAST.value,
        name="Podcast",
        description="Casual conversational style like a tech podcast episode",
        voice_character="Enthusiastic host, like a tech podcast personality",
        pacing="fast",
        tone="Casual, enthusiastic, conversational",
        chapter_pattern=[
            "Intro - Hey, Welcome Back!",
            "The Hook - Why This Repo is Cool",
            "Deep Dive - Let's Get Into It",
            "Hot Takes - What I Think About the Design",
            "Highlights - The Coolest Parts",
            "Wrap Up - Final Thoughts",
        ],
        example_phrases=[
            "So I've been digging into {repo_name} and honestly, it's pretty cool...",
            "Here's the thing that really got me excited...",
            "Now, I know what you're thinking, but hear me out...",
            "Alright, that's a wrap! Hope you enjoyed this deep dive.",
        ],
        voice_directions={
            "emphasis": "natural conversational emphasis",
            "pace": "energetic, occasional tangents",
            "emotion": "excitement, curiosity, genuine interest",
        },
    ),

    NarrativeStyle.TECHNICAL.value: StyleDefinition(
        style=NarrativeStyle.TECHNICAL.value,
        name="Technical",
        description="Precise technical documentation read aloud",
        voice_character="Technical reader, clear and precise",
        pacing="moderate",
        tone="Precise, factual, comprehensive",
        chapter_pattern=[
            "Overview - System Description",
            "Architecture - Component Structure",
            "API Reference - Key Interfaces",
            "Implementation Details - How It Works",
            "Configuration - Setup and Options",
            "Summary - Key Takeaways",
        ],
        example_phrases=[
            "This document describes the {repo_name} system...",
            "The architecture consists of the following components...",
            "The primary interface exposes these methods...",
            "Configuration is managed through environment variables...",
        ],
        voice_directions={
            "emphasis": "technical terms, function names",
            "pace": "measured, clear enunciation",
            "emotion": "neutral, professional",
        },
    ),
}


EXPERTISE_ADJUSTMENTS = {
    ExpertiseLevel.BEGINNER.value: "Explain concepts simply. Avoid jargon. Use analogies.",
    ExpertiseLevel.INTERMEDIATE.value: "Balance technical accuracy with accessibility.",
    ExpertiseLevel.EXPERT.value: "Use precise technical language. Assume deep knowledge.",
}


@tool(
    name="get_style_definition",
    description="Get the complete definition for a narrative style including voice characteristics, chapter patterns, and example phrases.",
    input_schema={
        "type": "object",
        "properties": {
            "style": {
                "type": "string",
                "enum": ["fiction", "documentary", "tutorial", "podcast", "technical"],
                "description": "The narrative style to retrieve"
            }
        },
        "required": ["style"]
    }
)
async def get_style_definition(args: dict) -> dict:
    """Get style definition by name."""
    style = args.get("style", "documentary").lower()

    if style not in STYLE_DEFINITIONS:
        return {
            "content": [{
                "type": "text",
                "text": json.dumps({"error": f"Unknown style: {style}"})
            }]
        }

    definition = STYLE_DEFINITIONS[style]
    return {
        "content": [{
            "type": "text",
            "text": json.dumps(definition.to_dict(), indent=2)
        }]
    }


@tool(
    name="get_style_prompt",
    description="Generate the system prompt for a narrative style with expertise level adjustment. Returns a complete prompt for Claude to use when generating story content.",
    input_schema={
        "type": "object",
        "properties": {
            "style": {
                "type": "string",
                "enum": ["fiction", "documentary", "tutorial", "podcast", "technical"],
                "description": "The narrative style"
            },
            "expertise": {
                "type": "string",
                "enum": ["beginner", "intermediate", "expert"],
                "default": "intermediate",
                "description": "Target audience expertise level"
            }
        },
        "required": ["style"]
    }
)
async def get_style_prompt(args: dict) -> dict:
    """Generate the system prompt for a narrative style."""
    style = args.get("style", "documentary").lower()
    expertise = args.get("expertise", "intermediate").lower()

    if style not in STYLE_DEFINITIONS:
        return {
            "content": [{
                "type": "text",
                "text": json.dumps({"error": f"Unknown style: {style}"})
            }]
        }

    definition = STYLE_DEFINITIONS[style]
    expertise_adjustment = EXPERTISE_ADJUSTMENTS.get(
        expertise,
        EXPERTISE_ADJUSTMENTS[ExpertiseLevel.INTERMEDIATE.value]
    )

    prompt = f'''You are a {definition.voice_character} creating a {definition.name} style code story.

## Style: {definition.name}
{definition.description}

## Voice Characteristics
- Tone: {definition.tone}
- Pacing: {definition.pacing}
- Character: {definition.voice_character}

## Audience
{expertise_adjustment}

## Example Phrases
{chr(10).join(f"- {phrase}" for phrase in definition.example_phrases)}

## Voice Synthesis Directions
- Emphasis: {definition.voice_directions.get("emphasis", "natural")}
- Pace: {definition.voice_directions.get("pace", "moderate")}
- Emotion: {definition.voice_directions.get("emotion", "engaged")}

Write content that captures this style authentically. Each chapter should feel like part of a cohesive {definition.name.lower()} narrative.'''

    return {"content": [{"type": "text", "text": prompt}]}


@tool(
    name="get_chapter_template",
    description="Get the chapter pattern template for a narrative style. Returns the list of chapter names/descriptions.",
    input_schema={
        "type": "object",
        "properties": {
            "style": {
                "type": "string",
                "enum": ["fiction", "documentary", "tutorial", "podcast", "technical"],
                "description": "The narrative style"
            }
        },
        "required": ["style"]
    }
)
async def get_chapter_template(args: dict) -> dict:
    """Get the chapter pattern for a style."""
    style = args.get("style", "documentary").lower()

    if style not in STYLE_DEFINITIONS:
        return {
            "content": [{
                "type": "text",
                "text": json.dumps({"error": f"Unknown style: {style}"})
            }]
        }

    definition = STYLE_DEFINITIONS[style]
    result = {
        "style": style,
        "chapters": definition.chapter_pattern,
        "chapter_count": len(definition.chapter_pattern),
    }

    return {"content": [{"type": "text", "text": json.dumps(result, indent=2)}]}


@tool(
    name="list_available_styles",
    description="List all available narrative styles with their basic descriptions.",
    input_schema={
        "type": "object",
        "properties": {},
        "required": []
    }
)
async def list_available_styles(args: dict) -> dict:
    """List all available narrative styles."""
    styles = []
    for style_key, definition in STYLE_DEFINITIONS.items():
        styles.append({
            "style": style_key,
            "name": definition.name,
            "description": definition.description,
            "pacing": definition.pacing,
            "tone": definition.tone,
        })

    result = {
        "styles": styles,
        "count": len(styles),
        "expertise_levels": ["beginner", "intermediate", "expert"],
    }

    return {"content": [{"type": "text", "text": json.dumps(result, indent=2)}]}
```

### Task 2: Create MCP Server for Style Tools

**File**: `src/codestory/tools/story/styles_server.py`

```python
"""MCP server for narrative style tools.

Uses Claude Agent SDK create_sdk_mcp_server.
"""

from claude_agent_sdk import create_sdk_mcp_server

from codestory.tools.story.styles import (
    get_style_definition,
    get_style_prompt,
    get_chapter_template,
    list_available_styles,
)


def create_styles_mcp_server():
    """Create MCP server with narrative style tools."""
    return create_sdk_mcp_server(
        name="styles",
        version="1.0.0",
        tools=[
            get_style_definition,
            get_style_prompt,
            get_chapter_template,
            list_available_styles,
        ],
    )
```

### Task 3: Create Story Package Init

**File**: `src/codestory/tools/story/__init__.py`

```python
"""Story generation tools for Code Story.

Uses Claude Agent SDK @tool decorator for MCP integration.
"""

from codestory.tools.story.styles import (
    NarrativeStyle,
    ExpertiseLevel,
    StyleDefinition,
    STYLE_DEFINITIONS,
    get_style_definition,
    get_style_prompt,
    get_chapter_template,
    list_available_styles,
)
from codestory.tools.story.styles_server import create_styles_mcp_server

__all__ = [
    # Enums
    "NarrativeStyle",
    "ExpertiseLevel",
    # Types
    "StyleDefinition",
    "STYLE_DEFINITIONS",
    # Tools
    "get_style_definition",
    "get_style_prompt",
    "get_chapter_template",
    "list_available_styles",
    # Server
    "create_styles_mcp_server",
]
```

### Task 4: Style Tools Tests

**File**: `tests/tools/story/test_styles.py`

```python
"""Tests for narrative style tools."""

import pytest
import json


@pytest.mark.asyncio
async def test_get_style_definition():
    """Test getting style definition."""
    from codestory.tools.story.styles import get_style_definition

    result = await get_style_definition({"style": "fiction"})

    assert "content" in result
    data = json.loads(result["content"][0]["text"])

    assert data["name"] == "Fiction"
    assert data["style"] == "fiction"
    assert len(data["chapter_pattern"]) == 6
    assert len(data["example_phrases"]) >= 3
    assert "voice_directions" in data


@pytest.mark.asyncio
async def test_get_style_prompt():
    """Test generating style prompt."""
    from codestory.tools.story.styles import get_style_prompt

    result = await get_style_prompt({
        "style": "documentary",
        "expertise": "beginner"
    })

    prompt = result["content"][0]["text"]

    assert "Documentary" in prompt
    assert "Explain concepts simply" in prompt
    assert "Voice Characteristics" in prompt
    assert "Example Phrases" in prompt


@pytest.mark.asyncio
async def test_get_style_prompt_default_expertise():
    """Test style prompt with default expertise."""
    from codestory.tools.story.styles import get_style_prompt

    result = await get_style_prompt({"style": "tutorial"})

    prompt = result["content"][0]["text"]

    assert "Tutorial" in prompt
    assert "Balance technical accuracy" in prompt  # intermediate default


@pytest.mark.asyncio
async def test_get_chapter_template():
    """Test getting chapter template."""
    from codestory.tools.story.styles import get_chapter_template

    result = await get_chapter_template({"style": "podcast"})

    data = json.loads(result["content"][0]["text"])

    assert data["style"] == "podcast"
    assert data["chapter_count"] == 6
    assert "Intro" in data["chapters"][0]
    assert "Wrap Up" in data["chapters"][-1]


@pytest.mark.asyncio
async def test_list_available_styles():
    """Test listing all styles."""
    from codestory.tools.story.styles import list_available_styles

    result = await list_available_styles({})

    data = json.loads(result["content"][0]["text"])

    assert data["count"] == 5
    assert len(data["styles"]) == 5

    style_names = [s["style"] for s in data["styles"]]
    assert "fiction" in style_names
    assert "documentary" in style_names
    assert "tutorial" in style_names
    assert "podcast" in style_names
    assert "technical" in style_names


@pytest.mark.asyncio
async def test_unknown_style():
    """Test handling unknown style."""
    from codestory.tools.story.styles import get_style_definition

    result = await get_style_definition({"style": "unknown"})

    data = json.loads(result["content"][0]["text"])
    assert "error" in data


@pytest.mark.asyncio
async def test_all_styles_have_voice_directions():
    """Test all styles have voice directions."""
    from codestory.tools.story.styles import STYLE_DEFINITIONS

    for style, definition in STYLE_DEFINITIONS.items():
        assert "emphasis" in definition.voice_directions
        assert "pace" in definition.voice_directions
        assert "emotion" in definition.voice_directions


@pytest.mark.asyncio
async def test_expertise_levels():
    """Test all expertise levels work."""
    from codestory.tools.story.styles import get_style_prompt

    for expertise in ["beginner", "intermediate", "expert"]:
        result = await get_style_prompt({
            "style": "documentary",
            "expertise": expertise
        })

        prompt = result["content"][0]["text"]
        assert "Documentary" in prompt
```

## Files Created/Modified

| File | Action | Purpose |
|------|--------|---------|
| `src/codestory/tools/story/styles.py` | Create | Narrative style definitions and tools |
| `src/codestory/tools/story/styles_server.py` | Create | MCP server for style tools |
| `src/codestory/tools/story/__init__.py` | Create | Story tools package init |
| `tests/tools/story/test_styles.py` | Create | Style tools tests |

## Tool Naming Convention

When accessed via MCP, tools use the pattern: `mcp__styles__<tool_name>`

- `mcp__styles__get_style_definition`
- `mcp__styles__get_style_prompt`
- `mcp__styles__get_chapter_template`
- `mcp__styles__list_available_styles`

## Validation Criteria

1. All 5 narrative styles defined with unique characteristics
2. Each style has 6 chapter patterns and 4+ example phrases
3. Voice synthesis directions included for each style
4. Expertise level adjustments modify language complexity
5. All tools return proper `{"content": [...]}` format

## Styles Summary

| Style | Voice | Pacing | Audience |
|-------|-------|--------|----------|
| Fiction | Dramatic narrator | Moderate | Engagement-focused |
| Documentary | Authoritative | Moderate | Understanding-focused |
| Tutorial | Friendly instructor | Slow | Learning-focused |
| Podcast | Enthusiastic host | Fast | Casual listeners |
| Technical | Precise reader | Moderate | Technical audience |

## Next Step

Ready for 04-02-PLAN.md (Chapter Script Generation)
