openapi: 3.1.0
info:
  title: Code Story API
  description: '

    # Code Story API


    Transform your repositories into engaging audio narratives.


    ## Overview


    Code Story analyzes your codebase and generates professional audio stories

    that explain your code''s architecture, design patterns, and implementation details.


    ## Authentication


    The API supports two authentication methods:


    ### JWT Bearer Token

    For web and mobile applications. Obtain a token via `/api/auth/login`.


    ```

    Authorization: Bearer <your-jwt-token>

    ```


    ### API Key

    For server-to-server integrations. Generate keys at `/api/api-keys`.


    ```

    X-API-Key: cs_<your-api-key>

    ```


    ## Rate Limits


    | Tier | Requests/hour | Stories/day | Audio mins/month |

    |------|--------------|-------------|------------------|

    | Free | 100 | 2 | 30 |

    | Pro | 1000 | 10 | 300 |

    | Team | 5000 | 50 | 1000 |

    | Enterprise | Unlimited | 500 | 10000 |


    ## Errors


    The API uses standard HTTP status codes:


    | Code | Description |

    |------|-------------|

    | 400 | Bad Request - Invalid parameters |

    | 401 | Unauthorized - Missing or invalid auth |

    | 402 | Payment Required - Quota exceeded |

    | 403 | Forbidden - Insufficient permissions |

    | 404 | Not Found - Resource doesn''t exist |

    | 429 | Too Many Requests - Rate limited |

    | 500 | Internal Error - Server issue |


    ## Narrative Styles


    | Style | Description |

    |-------|-------------|

    | documentary | Professional, PBS-style narration |

    | storytelling | Engaging narrative with characters |

    | educational | Tutorial-focused learning |

    | casual | Friendly podcast format |

    | executive | High-level business summary |


    ## Webhooks (Coming Soon)


    Subscribe to events like `story.created`, `story.completed`, `story.failed`.

    '
  contact:
    name: Code Story Support
    url: https://codestory.dev/support
    email: api-support@codestory.dev
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  version: 1.0.0
paths:
  /api/health:
    get:
      tags:
      - health
      summary: Health Check
      description: "Check application health status.\n\nReturns:\n    Health status\
        \ including SDK server and database connectivity."
      operationId: health_check_api_health_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /api/ready:
    get:
      tags:
      - health
      summary: Readiness Check
      description: "Kubernetes readiness probe.\n\nReturns:\n    Simple ready status."
      operationId: readiness_check_api_ready_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                additionalProperties: true
                type: object
                title: Response Readiness Check Api Ready Get
  /api/live:
    get:
      tags:
      - health
      summary: Liveness Check
      description: "Kubernetes liveness probe.\n\nReturns:\n    Simple alive status."
      operationId: liveness_check_api_live_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                additionalProperties: true
                type: object
                title: Response Liveness Check Api Live Get
  /api/auth/register:
    post:
      tags:
      - auth
      summary: Register
      description: "Register a new user with Supabase Auth.\n\nArgs:\n    request:\
        \ Registration data with email, password, and optional name.\n\nReturns:\n\
        \    Access and refresh tokens from Supabase.\n\nRaises:\n    HTTPException:\
        \ If registration fails."
      operationId: register_api_auth_register_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
        required: true
      responses:
        '201':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/login:
    post:
      tags:
      - auth
      summary: Login
      description: "Login with email and password via Supabase Auth.\n\nArgs:\n  \
        \  request: Login credentials.\n\nReturns:\n    Access and refresh tokens\
        \ from Supabase.\n\nRaises:\n    HTTPException: If credentials are invalid."
      operationId: login_api_auth_login_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/refresh:
    post:
      tags:
      - auth
      summary: Refresh Token
      description: "Refresh access token using refresh token.\n\nArgs:\n    request:\
        \ Refresh token.\n\nReturns:\n    New access and refresh tokens.\n\nRaises:\n\
        \    HTTPException: If refresh token is invalid."
      operationId: refresh_token_api_auth_refresh_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/me:
    get:
      tags:
      - auth
      summary: Get Current User Info
      description: "Get current authenticated user info from Supabase.\n\nArgs:\n\
        \    user: Current user from token.\n\nReturns:\n    User information."
      operationId: get_current_user_info_api_auth_me_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
      security:
      - HTTPBearer: []
  /api/auth/logout:
    post:
      tags:
      - auth
      summary: Logout
      description: "Logout current user from Supabase.\n\nArgs:\n    user: Current\
        \ user.\n\nReturns:\n    Logout confirmation."
      operationId: logout_api_auth_logout_post
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
      security:
      - HTTPBearer: []
  /api/auth/password/reset:
    post:
      tags:
      - auth
      summary: Request Password Reset
      description: "Request password reset email.\n\nArgs:\n    request: Email to\
        \ send reset link to.\n\nReturns:\n    Confirmation message."
      operationId: request_password_reset_api_auth_password_reset_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/password/update:
    post:
      tags:
      - auth
      summary: Update Password
      description: "Update password for authenticated user.\n\nArgs:\n    request:\
        \ New password.\n    user: Current user.\n\nReturns:\n    Success message."
      operationId: update_password_api_auth_password_update_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordUpdateRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
      security:
      - HTTPBearer: []
  /api/auth/oauth/{provider}:
    get:
      tags:
      - auth
      summary: Get Oauth Url
      description: "Get OAuth authorization URL for a provider.\n\nArgs:\n    provider:\
        \ OAuth provider (github, google, apple, discord).\n    redirect_to: URL to\
        \ redirect after auth.\n\nReturns:\n    Authorization URL."
      operationId: get_oauth_url_api_auth_oauth__provider__get
      parameters:
      - name: provider
        in: path
        required: true
        schema:
          type: string
          title: Provider
      - name: redirect_to
        in: query
        required: false
        schema:
          anyOf:
          - type: string
          - type: 'null'
          title: Redirect To
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: string
                title: Response Get Oauth Url Api Auth Oauth  Provider  Get
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/legacy/register:
    post:
      tags:
      - auth-legacy
      summary: Register
      description: "Register a new user.\n\nArgs:\n    request: Registration data\n\
        \    db: Database session\n\nReturns:\n    Access and refresh tokens\n\nRaises:\n\
        \    HTTPException: If email already exists"
      operationId: register_api_auth_legacy_register_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/codestory__api__routers__auth__RegisterRequest'
        required: true
      responses:
        '201':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/codestory__api__routers__auth__TokenResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/legacy/login:
    post:
      tags:
      - auth-legacy
      summary: Login
      description: "Login with email and password.\n\nArgs:\n    request: Login credentials\n\
        \    db: Database session\n\nReturns:\n    Access and refresh tokens\n\nRaises:\n\
        \    HTTPException: If credentials are invalid"
      operationId: login_api_auth_legacy_login_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/codestory__api__routers__auth__TokenResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/legacy/refresh:
    post:
      tags:
      - auth-legacy
      summary: Refresh Token
      description: "Refresh access token using refresh token.\n\nArgs:\n    request:\
        \ Refresh token\n    db: Database session\n\nReturns:\n    New access and\
        \ refresh tokens\n\nRaises:\n    HTTPException: If refresh token is invalid"
      operationId: refresh_token_api_auth_legacy_refresh_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/codestory__api__routers__auth__TokenResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/auth/legacy/me:
    get:
      tags:
      - auth-legacy
      summary: Get Current User Info
      description: "Get current authenticated user info.\n\nArgs:\n    user: Current\
        \ user from token\n\nReturns:\n    User information"
      operationId: get_current_user_info_api_auth_legacy_me_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/codestory__api__routers__auth__UserResponse'
      security:
      - HTTPBearer: []
  /api/auth/legacy/logout:
    post:
      tags:
      - auth-legacy
      summary: Logout
      description: "Logout current user.\n\nNote: Since we use stateless JWTs, this\
        \ is mainly for client-side\ntoken invalidation. For full invalidation, use\
        \ a token blacklist.\n\nArgs:\n    user: Current user\n\nReturns:\n    Logout\
        \ confirmation"
      operationId: logout_api_auth_legacy_logout_post
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
      security:
      - HTTPBearer: []
  /api/auth/legacy/change-password:
    post:
      tags:
      - auth-legacy
      summary: Change Password
      description: "Change current user's password.\n\nArgs:\n    current_password:\
        \ Current password for verification\n    new_password: New password\n    user:\
        \ Current user\n    db: Database session\n\nReturns:\n    Success message\n\
        \nRaises:\n    HTTPException: If current password is wrong"
      operationId: change_password_api_auth_legacy_change_password_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Body_change_password_api_auth_legacy_change_password_post'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
      security:
      - HTTPBearer: []
  /api/users/me:
    get:
      tags:
      - users
      summary: Get Profile
      description: "Get current user's profile.\n\nArgs:\n    user: Authenticated\
        \ user\n\nReturns:\n    User profile information"
      operationId: get_profile_api_users_me_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
      security:
      - HTTPBearer: []
    patch:
      tags:
      - users
      summary: Update Profile
      description: "Update current user's profile.\n\nArgs:\n    request: Fields to\
        \ update\n    user: Authenticated user\n    db: Database session\n\nReturns:\n\
        \    Updated user profile"
      operationId: update_profile_api_users_me_patch
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateRequest'
        required: true
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
      security:
      - HTTPBearer: []
  /api/users/me/api-keys:
    get:
      tags:
      - users
      summary: List Api Keys
      description: "List user's API keys.\n\nArgs:\n    user: Authenticated user\n\
        \    db: Database session\n\nReturns:\n    List of API keys (without the full\
        \ key)"
      operationId: list_api_keys_api_users_me_api_keys_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/APIKeyResponse'
                type: array
                title: Response List Api Keys Api Users Me Api Keys Get
      security:
      - HTTPBearer: []
    post:
      tags:
      - users
      summary: Create Api Key
      description: "Create a new API key.\n\nThe full key is only returned once on\
        \ creation.\nStore it securely - it cannot be retrieved again.\n\nArgs:\n\
        \    request: API key creation parameters\n    user: Authenticated user\n\
        \    db: Database session\n\nReturns:\n    Created API key with full key visible"
      operationId: create_api_key_api_users_me_api_keys_post
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/APIKeyCreateRequest'
        required: true
      responses:
        '201':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyCreatedResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
      security:
      - HTTPBearer: []
  /api/users/me/api-keys/{key_id}:
    delete:
      tags:
      - users
      summary: Delete Api Key
      description: "Delete an API key.\n\nArgs:\n    key_id: API key ID to delete\n\
        \    user: Authenticated user\n    db: Database session\n\nRaises:\n    NotFoundError:\
        \ If key doesn't exist or user doesn't own it"
      operationId: delete_api_key_api_users_me_api_keys__key_id__delete
      security:
      - HTTPBearer: []
      parameters:
      - name: key_id
        in: path
        required: true
        schema:
          type: integer
          title: Key Id
      responses:
        '204':
          description: Successful Response
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/users:
    get:
      tags:
      - users
      summary: List Users
      description: "List all users (admin only).\n\nArgs:\n    admin: Authenticated\
        \ admin user\n    db: Database session\n\nReturns:\n    List of all users"
      operationId: list_users_api_users_get
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/UserProfileResponse'
                type: array
                title: Response List Users Api Users Get
      security:
      - HTTPBearer: []
  /api/users/{user_id}/status:
    patch:
      tags:
      - users
      summary: Update User Status
      description: "Enable or disable a user (admin only).\n\nArgs:\n    user_id:\
        \ Target user ID\n    is_active: New active status\n    admin: Authenticated\
        \ admin user\n    db: Database session\n\nReturns:\n    Success message\n\n\
        Raises:\n    NotFoundError: If user doesn't exist\n    HTTPException: If trying\
        \ to modify own account"
      operationId: update_user_status_api_users__user_id__status_patch
      security:
      - HTTPBearer: []
      parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: integer
          title: User Id
      - name: is_active
        in: query
        required: true
        schema:
          type: boolean
          title: Is Active
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/stories:
    post:
      tags:
      - stories
      summary: Create a new story
      description: "Create a new audio story from a repository.\n\n    The story generation\
        \ process:\n    1. Repository is cloned and analyzed via Repomix\n    2. Code\
        \ structure and patterns are identified\n    3. Narrative outline is generated\
        \ based on style\n    4. Chapters are created with appropriate depth\n   \
        \ 5. Audio is synthesized using ElevenLabs\n\n    **Webhook Events**: `story.created`,\
        \ `story.analyzing`, `story.generating`, `story.completed`\n\n    Use the\
        \ SSE endpoint `/api/sse/stories/{story_id}` to track real-time progress."
      operationId: create_story_api_stories_post
      security:
      - HTTPBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoryCreateRequest'
      responses:
        '201':
          description: Story created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryResponse'
              example:
                id: 1
                title: Understanding My API
                status: pending
                narrative_style: educational
                focus_areas:
                - architecture
                repository_url: https://github.com/user/repo
                created_at: '2025-01-15T10:30:00Z'
        '400':
          description: Invalid repository URL or parameters
          content:
            application/json:
              example:
                detail: Invalid GitHub repository URL
        '402':
          description: Story quota exceeded
          content:
            application/json:
              example:
                detail:
                  error: Daily quota exceeded
                  quota_info:
                    daily:
                      used: 2
                      limit: 2
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
    get:
      tags:
      - stories
      summary: List user's stories
      description: "List all stories for the authenticated user with pagination.\n\
        \n    Supports filtering by:\n    - Status (pending, analyzing, generating,\
        \ completed, failed)\n\n    Results are paginated and sorted by creation date\
        \ (newest first)."
      operationId: list_stories_api_stories_get
      security:
      - HTTPBearer: []
      parameters:
      - name: page
        in: query
        required: false
        schema:
          type: integer
          minimum: 1
          description: Page number (1-indexed)
          default: 1
          title: Page
        description: Page number (1-indexed)
      - name: page_size
        in: query
        required: false
        schema:
          type: integer
          maximum: 100
          minimum: 1
          description: Items per page (max 100)
          default: 20
          title: Page Size
        description: Items per page (max 100)
      - name: status_filter
        in: query
        required: false
        schema:
          anyOf:
          - $ref: '#/components/schemas/StoryStatus'
          - type: 'null'
          description: Filter by story status
          title: Status Filter
        description: Filter by story status
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryListResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/stories/{story_id}:
    get:
      tags:
      - stories
      summary: Get story details
      description: "Retrieve detailed information about a specific story.\n\n    Includes:\n\
        \    - Story metadata and status\n    - List of chapters with durations\n\
        \    - Audio URLs (if completed)\n    - Error message (if failed)"
      operationId: get_story_api_stories__story_id__get
      security:
      - HTTPBearer: []
      parameters:
      - name: story_id
        in: path
        required: true
        schema:
          type: integer
          description: Unique story identifier
          title: Story Id
        description: Unique story identifier
      responses:
        '200':
          description: Story details with chapters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryResponse'
        '404':
          description: Story not found or not owned by user
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
    delete:
      tags:
      - stories
      summary: Delete a story
      description: Permanently delete a story and all its chapters.
      operationId: delete_story_api_stories__story_id__delete
      security:
      - HTTPBearer: []
      parameters:
      - name: story_id
        in: path
        required: true
        schema:
          type: integer
          description: Unique story identifier
          title: Story Id
        description: Unique story identifier
      responses:
        '204':
          description: Story deleted successfully
        '404':
          description: Story not found
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/stories/{story_id}/status:
    get:
      tags:
      - stories
      summary: Get story status
      description: "Lightweight endpoint for polling generation status.\n\n    Returns\
        \ current status, progress percentage, and current step.\n    For real-time\
        \ updates, use the SSE endpoint `/api/sse/stories/{story_id}`."
      operationId: get_story_status_api_stories__story_id__status_get
      security:
      - HTTPBearer: []
      parameters:
      - name: story_id
        in: path
        required: true
        schema:
          type: integer
          description: Unique story identifier
          title: Story Id
        description: Unique story identifier
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryStatusResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/stories/{story_id}/retry:
    post:
      tags:
      - stories
      summary: Retry failed story
      description: "Retry generation for a failed story.\n\n    Only works for stories\
        \ in FAILED status. Resets the status\n    to PENDING and restarts the Claude\
        \ Agent SDK pipeline."
      operationId: retry_story_api_stories__story_id__retry_post
      security:
      - HTTPBearer: []
      parameters:
      - name: story_id
        in: path
        required: true
        schema:
          type: integer
          description: Unique story identifier
          title: Story Id
        description: Unique story identifier
      responses:
        '200':
          description: Story retry initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryResponse'
        '400':
          description: Story is not in FAILED status
        '404':
          description: Story not found
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/sse/stories/{story_id}/progress:
    get:
      tags:
      - sse
      summary: Story Progress Stream
      description: "Stream story generation progress via SSE.\n\nArgs:\n    story_id:\
        \ Story ID to subscribe to\n    request: FastAPI request\n    user: Authenticated\
        \ user\n\nReturns:\n    SSE stream of progress events"
      operationId: story_progress_stream_api_sse_stories__story_id__progress_get
      security:
      - HTTPBearer: []
      parameters:
      - name: story_id
        in: path
        required: true
        schema:
          type: string
          title: Story Id
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema: {}
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/api-keys:
    post:
      tags:
      - api-keys
      - API Keys
      summary: Create Api Key
      description: 'Create a new API key for the authenticated user.


        The returned key is only shown once and cannot be retrieved later.

        Store it securely.'
      operationId: create_api_key_api_api_keys_post
      security:
      - HTTPBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/APIKeyCreate'
      responses:
        '201':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyCreated'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
    get:
      tags:
      - api-keys
      - API Keys
      summary: List Api Keys
      description: List all API keys for the authenticated user.
      operationId: list_api_keys_api_api_keys_get
      security:
      - HTTPBearer: []
      parameters:
      - name: active_only
        in: query
        required: false
        schema:
          type: boolean
          description: Only return active keys
          default: true
          title: Active Only
        description: Only return active keys
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyList'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/api-keys/{key_id}:
    get:
      tags:
      - api-keys
      - API Keys
      summary: Get Api Key
      description: Get details of a specific API key.
      operationId: get_api_key_api_api_keys__key_id__get
      security:
      - HTTPBearer: []
      parameters:
      - name: key_id
        in: path
        required: true
        schema:
          type: integer
          title: Key Id
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/codestory__api__routers__api_keys__APIKeyResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
    patch:
      tags:
      - api-keys
      - API Keys
      summary: Update Api Key
      description: Update an API key (name, active status, or rate limit).
      operationId: update_api_key_api_api_keys__key_id__patch
      security:
      - HTTPBearer: []
      parameters:
      - name: key_id
        in: path
        required: true
        schema:
          type: integer
          title: Key Id
      - name: name
        in: query
        required: false
        schema:
          anyOf:
          - type: string
          - type: 'null'
          title: Name
      - name: is_active
        in: query
        required: false
        schema:
          anyOf:
          - type: boolean
          - type: 'null'
          title: Is Active
      - name: rate_limit
        in: query
        required: false
        schema:
          anyOf:
          - type: integer
          - type: 'null'
          title: Rate Limit
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/codestory__api__routers__api_keys__APIKeyResponse'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
    delete:
      tags:
      - api-keys
      - API Keys
      summary: Delete Api Key
      description: Delete an API key (permanently).
      operationId: delete_api_key_api_api_keys__key_id__delete
      security:
      - HTTPBearer: []
      parameters:
      - name: key_id
        in: path
        required: true
        schema:
          type: integer
          title: Key Id
      responses:
        '204':
          description: Successful Response
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
  /api/api-keys/{key_id}/regenerate:
    post:
      tags:
      - api-keys
      - API Keys
      summary: Regenerate Api Key
      description: Regenerate an API key (invalidates the old key).
      operationId: regenerate_api_key_api_api_keys__key_id__regenerate_post
      security:
      - HTTPBearer: []
      parameters:
      - name: key_id
        in: path
        required: true
        schema:
          type: integer
          title: Key Id
      responses:
        '200':
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyCreated'
        '422':
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPValidationError'
components:
  schemas:
    APIKeyCreate:
      properties:
        name:
          type: string
          maxLength: 100
          minLength: 1
          title: Name
          description: Name for the API key
        permissions:
          items:
            type: string
          type: array
          title: Permissions
          description: Permissions for this key (read, write, admin)
          default:
          - read
        expires_in_days:
          anyOf:
          - type: integer
            maximum: 365.0
            minimum: 1.0
          - type: 'null'
          title: Expires In Days
          description: Days until expiration (null = never)
        rate_limit:
          type: integer
          maximum: 10000.0
          minimum: 10.0
          title: Rate Limit
          description: Requests per hour limit
          default: 1000
      type: object
      required:
      - name
      title: APIKeyCreate
      description: Request body for creating an API key.
    APIKeyCreateRequest:
      properties:
        name:
          type: string
          maxLength: 100
          minLength: 1
          title: Name
      type: object
      required:
      - name
      title: APIKeyCreateRequest
      description: Request to create a new API key.
    APIKeyCreated:
      properties:
        id:
          type: integer
          title: Id
        name:
          type: string
          title: Name
        permissions:
          items:
            type: string
          type: array
          title: Permissions
        rate_limit:
          type: integer
          title: Rate Limit
        is_active:
          type: boolean
          title: Is Active
        created_at:
          type: string
          title: Created At
        expires_at:
          anyOf:
          - type: string
          - type: 'null'
          title: Expires At
        last_used_at:
          anyOf:
          - type: string
          - type: 'null'
          title: Last Used At
        key:
          type: string
          title: Key
          description: The API key (only shown once)
      type: object
      required:
      - id
      - name
      - permissions
      - rate_limit
      - is_active
      - created_at
      - expires_at
      - last_used_at
      - key
      title: APIKeyCreated
      description: Response when creating a new API key (includes the actual key).
      example:
        id: 1
        name: CI/CD Pipeline Key
        key: cs_a1b2c3d4e5f6...
        permissions:
        - read
        - write
        rate_limit: 1000
        is_active: true
        created_at: '2025-01-15T10:30:00Z'
        expires_at: null
        last_used_at: null
    APIKeyCreatedResponse:
      properties:
        id:
          type: integer
          title: Id
        name:
          type: string
          title: Name
        key:
          type: string
          title: Key
        prefix:
          type: string
          title: Prefix
        created_at:
          type: string
          format: date-time
          title: Created At
      type: object
      required:
      - id
      - name
      - key
      - prefix
      - created_at
      title: APIKeyCreatedResponse
      description: Response with full API key (only shown once).
    APIKeyList:
      properties:
        keys:
          items:
            $ref: '#/components/schemas/codestory__api__routers__api_keys__APIKeyResponse'
          type: array
          title: Keys
        total:
          type: integer
          title: Total
      type: object
      required:
      - keys
      - total
      title: APIKeyList
      description: Response body for listing API keys.
    APIKeyResponse:
      properties:
        id:
          type: integer
          title: Id
        name:
          type: string
          title: Name
        prefix:
          type: string
          title: Prefix
        created_at:
          type: string
          format: date-time
          title: Created At
        last_used_at:
          anyOf:
          - type: string
            format: date-time
          - type: 'null'
          title: Last Used At
        is_active:
          type: boolean
          title: Is Active
      type: object
      required:
      - id
      - name
      - prefix
      - created_at
      - last_used_at
      - is_active
      title: APIKeyResponse
      description: API key response (key shown only on creation).
      example:
        id: 1
        name: CI/CD Pipeline Key
        permissions:
        - read
        - write
        rate_limit: 1000
        is_active: true
        created_at: '2025-01-15T10:30:00Z'
        expires_at: null
        last_used_at: '2025-01-15T12:45:00Z'
    Body_change_password_api_auth_legacy_change_password_post:
      properties:
        current_password:
          type: string
          title: Current Password
        new_password:
          type: string
          maxLength: 128
          minLength: 8
          title: New Password
      type: object
      required:
      - current_password
      - new_password
      title: Body_change_password_api_auth_legacy_change_password_post
    ChapterResponse:
      properties:
        id:
          type: integer
          title: Id
        order:
          type: integer
          title: Order
        title:
          type: string
          title: Title
        script:
          type: string
          title: Script
        audio_url:
          anyOf:
          - type: string
          - type: 'null'
          title: Audio Url
        start_time:
          type: number
          title: Start Time
        duration_seconds:
          anyOf:
          - type: number
          - type: 'null'
          title: Duration Seconds
      type: object
      required:
      - id
      - order
      - title
      - script
      - audio_url
      - start_time
      - duration_seconds
      title: ChapterResponse
      description: Chapter information response.
    HTTPValidationError:
      properties:
        detail:
          items:
            $ref: '#/components/schemas/ValidationError'
          type: array
          title: Detail
      type: object
      title: HTTPValidationError
    HealthResponse:
      properties:
        status:
          type: string
          title: Status
        version:
          type: string
          title: Version
        sdk_server:
          type: string
          title: Sdk Server
        database:
          type: string
          title: Database
      type: object
      required:
      - status
      - version
      - sdk_server
      - database
      title: HealthResponse
      description: Health check response.
    LoginRequest:
      properties:
        email:
          type: string
          format: email
          title: Email
        password:
          type: string
          title: Password
      type: object
      required:
      - email
      - password
      title: LoginRequest
      description: User login request.
    MessageResponse:
      properties:
        message:
          type: string
          title: Message
      type: object
      required:
      - message
      title: MessageResponse
      description: Simple message response.
    NarrativeStyle:
      type: string
      enum:
      - technical
      - storytelling
      - educational
      - casual
      - executive
      title: NarrativeStyle
      description: Available narrative styles for stories.
    PasswordResetRequest:
      properties:
        email:
          type: string
          format: email
          title: Email
      type: object
      required:
      - email
      title: PasswordResetRequest
      description: Password reset request.
    PasswordUpdateRequest:
      properties:
        new_password:
          type: string
          maxLength: 128
          minLength: 8
          title: New Password
      type: object
      required:
      - new_password
      title: PasswordUpdateRequest
      description: Password update request.
    RefreshRequest:
      properties:
        refresh_token:
          type: string
          title: Refresh Token
      type: object
      required:
      - refresh_token
      title: RefreshRequest
      description: Token refresh request.
    RegisterRequest:
      properties:
        email:
          type: string
          format: email
          title: Email
        password:
          type: string
          maxLength: 128
          minLength: 8
          title: Password
        name:
          type: string
          maxLength: 100
          title: Name
          default: ''
      type: object
      required:
      - email
      - password
      title: RegisterRequest
      description: User registration request.
    StoryCreateRequest:
      properties:
        repository_url:
          type: string
          maxLength: 2083
          minLength: 1
          format: uri
          title: Repository Url
          description: GitHub repository URL
        title:
          type: string
          maxLength: 255
          minLength: 1
          title: Title
        narrative_style:
          $ref: '#/components/schemas/NarrativeStyle'
          default: educational
        focus_areas:
          items:
            type: string
          type: array
          maxItems: 10
          title: Focus Areas
        user_intent:
          type: string
          title: User Intent
          description: What the user wants to learn about the repository
          default: Explain the architecture and key components
      type: object
      required:
      - repository_url
      - title
      title: StoryCreateRequest
      description: Request to create a new story.
    StoryListResponse:
      properties:
        items:
          items:
            $ref: '#/components/schemas/StoryResponse'
          type: array
          title: Items
        total:
          type: integer
          title: Total
        page:
          type: integer
          title: Page
        page_size:
          type: integer
          title: Page Size
        has_more:
          type: boolean
          title: Has More
      type: object
      required:
      - items
      - total
      - page
      - page_size
      - has_more
      title: StoryListResponse
      description: Paginated list of stories.
    StoryResponse:
      properties:
        id:
          type: integer
          title: Id
        title:
          type: string
          title: Title
        status:
          $ref: '#/components/schemas/StoryStatus'
        narrative_style:
          $ref: '#/components/schemas/NarrativeStyle'
        focus_areas:
          items:
            type: string
          type: array
          title: Focus Areas
        repository_url:
          type: string
          title: Repository Url
        audio_url:
          anyOf:
          - type: string
          - type: 'null'
          title: Audio Url
        transcript:
          anyOf:
          - type: string
          - type: 'null'
          title: Transcript
        duration_seconds:
          anyOf:
          - type: number
          - type: 'null'
          title: Duration Seconds
        error_message:
          anyOf:
          - type: string
          - type: 'null'
          title: Error Message
        chapters:
          items:
            $ref: '#/components/schemas/ChapterResponse'
          type: array
          title: Chapters
        created_at:
          type: string
          format: date-time
          title: Created At
        updated_at:
          type: string
          format: date-time
          title: Updated At
        completed_at:
          anyOf:
          - type: string
            format: date-time
          - type: 'null'
          title: Completed At
      type: object
      required:
      - id
      - title
      - status
      - narrative_style
      - focus_areas
      - repository_url
      - audio_url
      - transcript
      - duration_seconds
      - error_message
      - chapters
      - created_at
      - updated_at
      - completed_at
      title: StoryResponse
      description: Story information response.
      example:
        id: story_abc123
        title: Understanding FastAPI Architecture
        status: completed
        repo_url: https://github.com/tiangolo/fastapi
        narrative_style: documentary
        total_duration_seconds: 1847
        chapter_count: 5
        created_at: '2025-01-15T10:30:00Z'
    StoryStatus:
      type: string
      enum:
      - pending
      - analyzing
      - generating
      - synthesizing
      - complete
      - failed
      title: StoryStatus
      description: Status of story generation pipeline.
    StoryStatusResponse:
      properties:
        id:
          type: integer
          title: Id
        status:
          $ref: '#/components/schemas/StoryStatus'
        progress_percent:
          type: integer
          title: Progress Percent
        current_step:
          type: string
          title: Current Step
        error_message:
          anyOf:
          - type: string
          - type: 'null'
          title: Error Message
      type: object
      required:
      - id
      - status
      - progress_percent
      - current_step
      - error_message
      title: StoryStatusResponse
      description: Story status with progress.
    TokenResponse:
      properties:
        access_token:
          type: string
          title: Access Token
        refresh_token:
          type: string
          title: Refresh Token
        token_type:
          type: string
          title: Token Type
          default: bearer
        expires_in:
          type: integer
          title: Expires In
        expires_at:
          anyOf:
          - type: integer
          - type: 'null'
          title: Expires At
        user:
          anyOf:
          - additionalProperties: true
            type: object
          - type: 'null'
          title: User
      type: object
      required:
      - access_token
      - refresh_token
      - expires_in
      title: TokenResponse
      description: Supabase token response.
    UserProfileResponse:
      properties:
        id:
          type: integer
          title: Id
        email:
          type: string
          title: Email
        name:
          type: string
          title: Name
        is_active:
          type: boolean
          title: Is Active
        is_admin:
          type: boolean
          title: Is Admin
        created_at:
          type: string
          format: date-time
          title: Created At
        last_login_at:
          anyOf:
          - type: string
            format: date-time
          - type: 'null'
          title: Last Login At
      type: object
      required:
      - id
      - email
      - name
      - is_active
      - is_admin
      - created_at
      - last_login_at
      title: UserProfileResponse
      description: User profile response.
    UserProfileUpdateRequest:
      properties:
        name:
          anyOf:
          - type: string
            maxLength: 100
            minLength: 1
          - type: 'null'
          title: Name
        email:
          anyOf:
          - type: string
            format: email
          - type: 'null'
          title: Email
      type: object
      title: UserProfileUpdateRequest
      description: Request to update user profile.
    UserResponse:
      properties:
        id:
          type: string
          title: Id
        email:
          type: string
          title: Email
        name:
          type: string
          title: Name
          default: ''
        is_active:
          type: boolean
          title: Is Active
          default: true
        is_superuser:
          type: boolean
          title: Is Superuser
          default: false
        subscription_tier:
          type: string
          title: Subscription Tier
          default: free
        created_at:
          anyOf:
          - type: string
            format: date-time
          - type: 'null'
          title: Created At
      type: object
      required:
      - id
      - email
      title: UserResponse
      description: User info response from Supabase.
    ValidationError:
      properties:
        loc:
          items:
            anyOf:
            - type: string
            - type: integer
          type: array
          title: Location
        msg:
          type: string
          title: Message
        type:
          type: string
          title: Error Type
      type: object
      required:
      - loc
      - msg
      - type
      title: ValidationError
    codestory__api__routers__api_keys__APIKeyResponse:
      properties:
        id:
          type: integer
          title: Id
        name:
          type: string
          title: Name
        permissions:
          items:
            type: string
          type: array
          title: Permissions
        rate_limit:
          type: integer
          title: Rate Limit
        is_active:
          type: boolean
          title: Is Active
        created_at:
          type: string
          title: Created At
        expires_at:
          anyOf:
          - type: string
          - type: 'null'
          title: Expires At
        last_used_at:
          anyOf:
          - type: string
          - type: 'null'
          title: Last Used At
      type: object
      required:
      - id
      - name
      - permissions
      - rate_limit
      - is_active
      - created_at
      - expires_at
      - last_used_at
      title: APIKeyResponse
      description: Response body for API key operations.
    codestory__api__routers__auth__RegisterRequest:
      properties:
        email:
          type: string
          format: email
          title: Email
        password:
          type: string
          maxLength: 128
          minLength: 8
          title: Password
      type: object
      required:
      - email
      - password
      title: RegisterRequest
      description: User registration request.
    codestory__api__routers__auth__TokenResponse:
      properties:
        access_token:
          type: string
          title: Access Token
        refresh_token:
          type: string
          title: Refresh Token
        token_type:
          type: string
          title: Token Type
          default: bearer
        expires_in:
          type: integer
          title: Expires In
      type: object
      required:
      - access_token
      - refresh_token
      - expires_in
      title: TokenResponse
      description: JWT token response.
    codestory__api__routers__auth__UserResponse:
      properties:
        id:
          type: integer
          title: Id
        email:
          type: string
          title: Email
        is_active:
          type: boolean
          title: Is Active
        is_superuser:
          type: boolean
          title: Is Superuser
        subscription_tier:
          type: string
          title: Subscription Tier
        created_at:
          type: string
          format: date-time
          title: Created At
      type: object
      required:
      - id
      - email
      - is_active
      - is_superuser
      - subscription_tier
      - created_at
      title: UserResponse
      description: User info response.
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /api/auth/login or Supabase Auth
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: 'API key from /api/api-keys (format: cs_<hex>)'
tags:
- name: health
  description: Health check and system status endpoints
- name: auth
  description: User authentication via Supabase Auth service
- name: auth-legacy
  description: Legacy JWT authentication (deprecated, use Supabase auth)
- name: stories
  description: Create and manage audio stories from repositories
- name: api-keys
  description: Manage API keys for programmatic access
- name: users
  description: User profile and settings management
- name: sse
  description: Server-Sent Events for real-time story generation updates
servers:
- url: http://localhost:8000
  description: Local development
- url: https://api.codestory.dev
  description: Production server
- url: https://api-staging.codestory.dev
  description: Staging server
